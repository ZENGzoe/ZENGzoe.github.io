<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 水波纹进度条实现原理 · 曾洁仪博客</title><meta name="description" content="水波纹进度条实现原理 - Zeng Zoe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="css/googleapisFonts.css" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/zengjieyi1994" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/ZENGzoe" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><span style="display:none !important;"><span id="busuanzi_container_page_pv">本文总阅读量<span id="busuanzi_value_page_pv"></span></span></span><article class="post-block"><h1 class="post-title">水波纹进度条实现原理</h1><div class="post-time">2018年8月1日</div><div class="post-content"><p><img src="/2018/08/02/水波纹进度条实现原理/designSketch.gif" alt=""></p>
<p>项目中使用水波纹进度条，可以让项目的预加载更加生动，用户等待阶段相对也没那么无聊～～</p>
<p>本项目中使用Canvas模拟水波纹滚动效果来实现，主要原理是数学的正弦曲线。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>水波纹外形上酷似正弦曲线，于是通过正弦曲线去分析水波纹的实现原理。</p>
<p><img src="/2018/08/02/水波纹进度条实现原理/sinusoid.jpg" alt=""></p>
<blockquote>
<p>正弦曲线公式为<code>y=Asin(ωx+φ)+k</code></p>
</blockquote>
<p>A为振幅，改变该值，可改变水波纹波浪的深度，A越大，水波纹越陡，A越小，水波纹越平。</p>
<p><img src="/2018/08/02/水波纹进度条实现原理/sinusoid2.jpg" alt=""></p>
<p>φ为出相，改变该值，可改变水波纹水平方向的位置，φ为正数，水波纹向右移动，φ为负数，水波纹向左移动。</p>
<p><img src="/2018/08/02/水波纹进度条实现原理/sinusoid3.jpg" alt=""></p>
<p>k为偏距，改变改值，可改变水波纹垂直方向的位置。</p>
<p><img src="/2018/08/02/水波纹进度条实现原理/sinusoid4.jpg" alt=""></p>
<p>ω为角速度，改变改值，可改变水波纹波浪的宽度，ω越大，水波纹越窄，ω越小，水波纹越宽。</p>
<p><img src="/2018/08/02/水波纹进度条实现原理/sinusoid5.jpg" alt=""></p>
<p>通过正弦曲线的原理，水波纹进度条由下往上移动，可以通过增大k向上移动实现，水波纹的滚动可以通过φ从右至左移动，水波纹的形状由正弦曲线形成。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p><strong> 1.画出波浪线 </strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> wave = &#123;</span><br><span class="line">    init : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> canvas = <span class="built_in">document</span>.getElementById(<span class="string">'canvas'</span>),</span><br><span class="line">            winW = <span class="built_in">document</span>.body.clientWidth;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">this</span>.ctx = canvas.getContext(<span class="string">'2d'</span>);</span><br><span class="line">        canvas.width = winW * <span class="number">0.6</span>;</span><br><span class="line">        canvas.height = winW * <span class="number">0.6</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.canvasW = canvas.width;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.draw()</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//所有绘制</span></span><br><span class="line">    draw : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.drawWave(<span class="keyword">this</span>.ctx);</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//画波浪线</span></span><br><span class="line">    drawWave : <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> canvasW = <span class="keyword">this</span>.canvasW,</span><br><span class="line">            startX = <span class="number">0</span>,     <span class="comment">//波浪线初始x轴坐标</span></span><br><span class="line">            waveH = <span class="number">6</span>,      <span class="comment">//波浪深度</span></span><br><span class="line">            waveW = <span class="number">0.04</span>,   <span class="comment">//波浪宽度</span></span><br><span class="line">            offsetY = canvasW*<span class="number">0.5</span>;     <span class="comment">//波浪垂直距离</span></span><br><span class="line"></span><br><span class="line">        ctx.beginPath();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> x = startX ; x &lt; canvasW ; x += <span class="number">20</span> / canvasW)&#123;</span><br><span class="line">            <span class="comment">//正弦曲线公式：y=Asin(ωx+φ)+k</span></span><br><span class="line">            <span class="keyword">var</span> y = waveH * <span class="built_in">Math</span>.sin((startX + x) * waveW) + offsetY;   </span><br><span class="line">            points.push([x ,y]);</span><br><span class="line">            ctx.lineTo(x , y);</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.stroke();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">wave.init()</span><br></pre></td></tr></table></figure>
<p>根据想要的效果设定波浪深度<code>waveH</code>、波浪宽度<code>waveW</code>。</p>
<p><img src="/2018/08/02/水波纹进度条实现原理/wave.png" alt=""></p>
<p><strong> 2.添加波浪流动效果 </strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> wave = &#123;</span><br><span class="line">    speed : <span class="number">50</span> ,   <span class="comment">//波浪横向流动速度</span></span><br><span class="line">    offsetX : <span class="number">0</span> ,   <span class="comment">//波浪横向偏移量</span></span><br><span class="line">    init : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//所有绘制</span></span><br><span class="line">    draw : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.ctx.clearRect(<span class="number">0</span>,<span class="number">0</span>,<span class="keyword">this</span>.canvasW,<span class="keyword">this</span>.canvasW);</span><br><span class="line">        <span class="keyword">this</span>.offsetX += <span class="keyword">this</span>.speed;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.drawWave(<span class="keyword">this</span>.ctx);</span><br><span class="line"></span><br><span class="line">        requestAnimationFrame(<span class="keyword">this</span>.draw.bind(<span class="keyword">this</span>));</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//画波浪线</span></span><br><span class="line">    drawWave : <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>)</span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> x = startX ; x &lt; canvasW ; x += <span class="number">20</span> / canvasW)&#123;</span><br><span class="line">            <span class="comment">//正弦曲线公式：y=Asin(ωx+φ)+k</span></span><br><span class="line">            <span class="keyword">var</span> y = waveH * <span class="built_in">Math</span>.sin((startX + x) * waveW + <span class="keyword">this</span>.offsetX) + offsetY;   </span><br><span class="line">            ctx.lineTo(x , y);</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.stroke();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">wave.init()</span><br></pre></td></tr></table></figure>
<p>通过波浪快速水平滑动，做出波浪流动效果。通过循环修改<code>φ</code>即<code>offsetX</code>，移动波浪线。每次循环绘制波浪线前需要清除画板<code>this.ctx.clearRect(0,0,this.canvasW,this.canvasW);</code>，重新绘制波浪线。</p>
<p><img src="/2018/08/02/水波纹进度条实现原理/waving.gif" alt=""></p>
<p><strong> 3.雏形 </strong></p>
<p>画出水波纹进度条整体雏形，添加色彩～</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> wave = &#123;</span><br><span class="line">    ...</span><br><span class="line">    isDrawContainer : <span class="literal">false</span>,        <span class="comment">//判断是否画了容器</span></span><br><span class="line">    init : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//所有绘制</span></span><br><span class="line">    draw : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">this</span>.isDrawContainer)&#123;</span><br><span class="line">            <span class="keyword">this</span>.drawContainer(ctx);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    drawContainer : <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> pointR = <span class="keyword">this</span>.canvasW / <span class="number">2</span>,</span><br><span class="line">            lineWidth = <span class="number">10</span> ,</span><br><span class="line">            circleR = pointR - (lineWidth);</span><br><span class="line"></span><br><span class="line">        ctx.lineWidth = lineWidth;</span><br><span class="line">        ctx.beginPath();</span><br><span class="line">        ctx.arc(pointR,pointR,circleR,<span class="number">0</span>,<span class="number">2</span> * <span class="built_in">Math</span>.PI);</span><br><span class="line">        ctx.strokeStyle = <span class="string">'rgba(192,225,242,0.3)'</span>;</span><br><span class="line">        ctx.stroke();</span><br><span class="line">        ctx.clip();</span><br><span class="line">        <span class="keyword">this</span>.isDrawContainer = <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">//画波浪线</span></span><br><span class="line">    drawWave : <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>)</span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">//画出完整的波浪形状</span></span><br><span class="line">        ctx.lineTo(canvasW , canvasW);</span><br><span class="line">        ctx.lineTo(startX , canvasW);</span><br><span class="line">        ctx.lineTo(startPos[<span class="number">0</span>] , startPos[<span class="number">1</span>]);</span><br><span class="line">        ctx.fillStyle = <span class="string">'#a4def6'</span>;</span><br><span class="line">        ctx.fill();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">wave.init()</span><br></pre></td></tr></table></figure>
<p>通过｀drawContainer｀函数画出滚动条容器，并剪切出需要的区域，通过<code>isDrawContainer</code>判断，优化性能。</p>
<p><img src="/2018/08/02/水波纹进度条实现原理/container.gif" alt=""></p>
<p><strong> 4.添加波浪溢满效果 </strong></p>
<p>可以通过偏距<code>k</code>即<code>offsetY</code>来移动波浪的垂直方向的高度，但由于canvas的y轴方向与正弦曲线的y轴相反，填充的方向相同，故在本例子中，通过修改y轴初始值来实现该效果。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> wave = &#123;</span><br><span class="line">    offsetYRange : <span class="number">1.1</span> ,            <span class="comment">//波浪垂直方向最大范围</span></span><br><span class="line">    offsetY : <span class="number">0</span>,                    <span class="comment">//波浪垂直方向位移</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//所有绘制</span></span><br><span class="line">    draw : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.offsetY &lt; <span class="keyword">this</span>.offsetYRange)&#123;</span><br><span class="line">            <span class="keyword">this</span>.offsetY += <span class="number">0.003</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//画波浪线</span></span><br><span class="line">    drawWave : <span class="function"><span class="keyword">function</span>(<span class="params">ctx</span>)</span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> x = startX ; x &lt; canvasW ; x += <span class="number">20</span> / canvasW)&#123;</span><br><span class="line">            <span class="comment">//正弦曲线公式：y=Asin(ωx+φ)+k</span></span><br><span class="line">            <span class="keyword">var</span> y = (<span class="number">1</span>-<span class="keyword">this</span>.offsetY) * canvasW + waveH * <span class="built_in">Math</span>.sin((startX + x) * waveW + <span class="keyword">this</span>.offsetX); </span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...    &#125;</span><br><span class="line">&#125;</span><br><span class="line">wave.init()</span><br></pre></td></tr></table></figure>
<p><img src="/2018/08/02/水波纹进度条实现原理/fill.gif" alt=""></p>
<p><strong> 5.添加海浪真实感 </strong></p>
<p>通过添加多一条颜色深的波浪来实现海浪真实感。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> wave = &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//所有绘制</span></span><br><span class="line">    draw : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.drawWave(ctx , <span class="keyword">this</span>.offsetX , <span class="keyword">this</span>.offsetY , <span class="number">0.04</span> , <span class="number">6</span> , <span class="string">'#a4def6'</span>);</span><br><span class="line">        <span class="keyword">this</span>.drawWave(ctx , <span class="keyword">this</span>.offsetX + <span class="number">2</span> , <span class="keyword">this</span>.offsetY  - <span class="number">0.02</span>, <span class="number">0.04</span> , <span class="number">8</span>, <span class="string">'#79d4f9'</span>);</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//画波浪线</span></span><br><span class="line">    drawWave : <span class="function"><span class="keyword">function</span>(<span class="params">ctx , offsetX , offsetY , waveW , waveH , color</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">var</span> canvasW = <span class="keyword">this</span>.canvasW,</span><br><span class="line">            startX = <span class="number">0</span>;     <span class="comment">//波浪线初始x轴坐标</span></span><br><span class="line"></span><br><span class="line">        ctx.beginPath();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> startPos = [startX];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> x = startX ; x &lt; canvasW ; x += <span class="number">20</span> / canvasW)&#123;</span><br><span class="line">            <span class="comment">//正弦曲线公式：y=Asin(ωx+φ)+k</span></span><br><span class="line">            <span class="keyword">var</span> y = (<span class="number">1</span> - offsetY) * canvasW + waveH * <span class="built_in">Math</span>.sin((startX + x) * waveW + offsetX); </span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">wave.init()</span><br></pre></td></tr></table></figure>
<p>波浪数据通过多次测试出最佳效果而得出。</p>
<p><img src="/2018/08/02/水波纹进度条实现原理/addWave.gif" alt=""></p>
<p><strong> 6.添加进度数据 </strong></p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> wave = &#123;</span><br><span class="line">    ...</span><br><span class="line">    offsetYSpeed : <span class="number">0.003</span>,            <span class="comment">//波浪溢满</span></span><br><span class="line">    progressNum : <span class="number">0</span>,                    <span class="comment">//进度</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">//所有绘制</span></span><br><span class="line">    draw : function()&#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.offsetY &lt; <span class="keyword">this</span>.offsetYRange)&#123;</span><br><span class="line">            <span class="keyword">this</span>.offsetY += <span class="keyword">this</span>.offsetYSpeed;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.progressNum += <span class="number">100</span>/(<span class="keyword">this</span>.offsetYRange/<span class="keyword">this</span>.offsetYSpeed);</span><br><span class="line"></span><br><span class="line">            document.querySelector(<span class="string">'.proNum'</span>).innerHTML = parseInt(<span class="keyword">this</span>.progressNum) + <span class="string">'%'</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">wave.init()</span><br></pre></td></tr></table></figure>
<p>最终效果如下：</p>
<p><img src="/2018/08/02/水波纹进度条实现原理/designSketch.gif" alt=""></p>
<p>源码：<a href="https://github.com/ZENGzoe/wave-progress" target="_blank" rel="noopener">https://github.com/ZENGzoe/wave-progress</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2018/08/12/PWA学习总结/" class="prev">PRVE</a><a href="/2018/06/04/charles使用总结/" class="next">NEXT</a></div><div data-thread-key="2018/08/02/水波纹进度条实现原理/" data-title="水波纹进度条实现原理" data-url="http://zengzoe.github.io/2018/08/02/水波纹进度条实现原理/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"zengzoe"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2016 - 2018 <a href="http://zengzoe.github.io">Zeng Zoe</a>, unless otherwise noted.</p><p style="display:none !important;"><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span><span id="busuanzi_container_site_uv">本站总访客数<span id="busuanzi_value_site_uv"></span>人次</span></p></div></footer><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>