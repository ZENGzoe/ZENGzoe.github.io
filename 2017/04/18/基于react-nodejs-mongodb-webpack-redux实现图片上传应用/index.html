<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 基于react+nodejs+mongodb+webpack+redux实现图片上传应用 · 曾洁仪博客</title><meta name="description" content="基于react+nodejs+mongodb+webpack+redux实现图片上传应用 - Zeng Zoe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="css/googleapisFonts.css" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/zengjieyi1994" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/ZENGzoe" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><span style="display:none !important;"><span id="busuanzi_container_page_pv">本文总阅读量<span id="busuanzi_value_page_pv"></span></span></span><article class="post-block"><h1 class="post-title">基于react+nodejs+mongodb+webpack+redux实现图片上传应用</h1><div class="post-time">2017年4月18日</div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>为了能够更好地掌握react、nodejs、webpack等知识，开始这个基于react+nodejs+mongodb+webpack+redux实现前后端图片上传的应用。这个项目从开始到实现，包括了登陆、注册、图片展示等页面，功能较简单，有登录、注册、上传图片、复制图片链接、删除图片等功能。在这过程中，遇到了很多个bug，但每一个bug都可以让我对知识的学习了解更加巩固。</p>
<h2 id="技术栈"><a href="#技术栈" class="headerlink" title="技术栈"></a>技术栈</h2><p>react+webpack+mongodb+webpack+redux+ES6+fetch</p>
<h2 id="项目运行"><a href="#项目运行" class="headerlink" title="项目运行"></a>项目运行</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">//下载项目</span><br><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> https://github.com/ggstudy-ddup/react-pic-uploader.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> react-pic-uploader/demo</span></span><br><span class="line">//安装依赖</span><br><span class="line"><span class="meta">$</span><span class="bash"> npm install</span></span><br><span class="line">//启动项目</span><br><span class="line"><span class="meta">$</span><span class="bash"> webpack &amp;&amp; node server.js</span></span><br></pre></td></tr></table></figure>
<h2 id="搭建开发环境"><a href="#搭建开发环境" class="headerlink" title="搭建开发环境"></a>搭建开发环境</h2><hr>
<h4 id="npm初始化"><a href="#npm初始化" class="headerlink" title="npm初始化"></a>npm初始化</h4><p>首先创建名为uploader的目录，切换到此目录，然后初始化文件。<br><figure class="highlight dos"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> uploader &amp;&amp; <span class="built_in">cd</span> uploader</span><br><span class="line">npm init</span><br></pre></td></tr></table></figure></p>
<h4 id="安装必要的开发工具包"><a href="#安装必要的开发工具包" class="headerlink" title="安装必要的开发工具包"></a>安装必要的开发工具包</h4><ul>
<li>webpack : 模块打包工具</li>
<li>redux : javascript状态容器</li>
<li>formidable : 用于上传文件的node.js模块包</li>
<li>express-session : 用于将数据存储在服务器上的node.js中间件</li>
<li>body-parser : node.js解析body的中间键</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">npm <span class="keyword">install</span> webpack redux formidable express-<span class="keyword">session</span> <span class="keyword">body</span>-parser <span class="comment">--save-dev</span></span><br></pre></td></tr></table></figure>
<h4 id="安装生产环境依赖包"><a href="#安装生产环境依赖包" class="headerlink" title="安装生产环境依赖包"></a>安装生产环境依赖包</h4><ul>
<li>react : 主要框架</li>
<li>react-dom : React的DOM操作类</li>
<li>react-router : React的路由库</li>
<li>express : 主要的node.js Web应用框架</li>
<li>cookie-parser : express中使用cookie的API</li>
<li>csurf : node.js csrf防御中间件</li>
<li>mongoose : mongoose数据库</li>
<li>path : node.js用于处理文件路径的模块</li>
<li>fs : node.js用于提供本地文件读写能力的模块</li>
</ul>
<figure class="highlight maxima"><table><tr><td class="code"><pre><span class="line">npm install react react-dom react-router <span class="built_in">express</span> cookie-parser csurf mongoose --<span class="built_in">save</span></span><br></pre></td></tr></table></figure>
<h4 id="搭建node-js服务器"><a href="#搭建node-js服务器" class="headerlink" title="搭建node.js服务器"></a>搭建node.js服务器</h4><p>这个项目中使用<a href="http://expressjs.com/zh-cn/" target="_blank" rel="noopener">express</a>框架搭建。搭建express基本目录结构：<br><img src="/2017/04/18/基于react-nodejs-mongodb-webpack-redux实现图片上传应用/01.png" alt=""><br><strong> public是项目的静态文件，</strong>放置js css img等文件<br><strong> routes是项目的路由信息文件，</strong>控制地址路由<br>在uploader的目录中，创建名为server.js的文件，添加如下代码：<br><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="keyword">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> cookieParser = <span class="keyword">require</span>(<span class="string">"cookie-parser"</span>);</span><br><span class="line"><span class="keyword">var</span> csrf = <span class="keyword">require</span>(<span class="string">'csurf'</span>);</span><br><span class="line"><span class="keyword">var</span> mongoose = <span class="keyword">require</span>(<span class="string">"mongoose"</span>);</span><br><span class="line"><span class="keyword">var</span> session = <span class="keyword">require</span>(<span class="string">'express-session'</span>);</span><br><span class="line"><span class="keyword">var</span> bodyParser = <span class="keyword">require</span>(<span class="string">'body-parser'</span>);</span><br><span class="line"><span class="keyword">var</span> routes = <span class="keyword">require</span>(<span class="string">'./routes/index'</span>);</span><br><span class="line"><span class="keyword">var</span> checkedRoutes = <span class="keyword">require</span>(<span class="string">'./routes/checkedIndex'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//mongoose数据库</span></span><br><span class="line"><span class="keyword">global</span>.dbHandle = <span class="keyword">require</span>(<span class="string">'./database/dbHandle'</span>);</span><br><span class="line"><span class="keyword">global</span>.db = mongoose.connect(<span class="string">"mongodb://localhost:27017/uploadimgdb"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"></span><br><span class="line">app.<span class="keyword">use</span>(cookieParser());</span><br><span class="line">app.<span class="keyword">use</span>(express.<span class="keyword">static</span>(__dirname));</span><br><span class="line">app.<span class="keyword">use</span>(bodyParser.json());</span><br><span class="line">app.<span class="keyword">use</span>(bodyParser.urlencoded(&#123;extended : <span class="keyword">true</span>&#125;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="keyword">use</span>(session(&#123;</span><br><span class="line">    secret : <span class="string">'hello'</span>,</span><br><span class="line">    resave : <span class="keyword">false</span>,</span><br><span class="line">    saveUninitialized : <span class="keyword">true</span>,</span><br><span class="line">    cookie : &#123;</span><br><span class="line">        path : <span class="string">"/"</span>,</span><br><span class="line">        maxAge : <span class="number">600000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line">app.<span class="keyword">use</span>(<span class="string">"/"</span>,routes);</span><br><span class="line">app.<span class="keyword">use</span>(<span class="string">'/upload'</span>, routes);</span><br><span class="line">app.<span class="keyword">use</span>(<span class="string">'/register'</span>, routes);</span><br><span class="line">app.<span class="keyword">use</span>(<span class="string">'/login'</span>, routes);</span><br><span class="line">app.<span class="keyword">use</span>(<span class="string">'/logout'</span>, routes);</span><br><span class="line">app.<span class="keyword">use</span>(<span class="string">'/getImages'</span>, routes);</span><br><span class="line"></span><br><span class="line"><span class="comment">// csrf防御</span></span><br><span class="line">app.<span class="keyword">use</span>(csrf());</span><br><span class="line">app.<span class="keyword">use</span>(<span class="string">"/"</span>,checkedRoutes);</span><br><span class="line">app.<span class="keyword">use</span>(<span class="string">'/isLogin'</span>, checkedRoutes);</span><br><span class="line">app.<span class="keyword">use</span>(<span class="string">'/deleteImages'</span>, checkedRoutes);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//error handle</span></span><br><span class="line">app.<span class="keyword">use</span>((err,req,res,next) =&gt; &#123;</span><br><span class="line">    res.status(err.status || <span class="number">500</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务器</span></span><br><span class="line"><span class="keyword">var</span> PORT = process.env.PORT || <span class="number">9990</span>;</span><br><span class="line">app.listen(PORT,<span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span><br><span class="line">    console.log(<span class="string">'Production Express server running at localhost:'</span> + PORT)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>在server.js源码中的判断是否登录与删除图片需要csrf防御，所以将这两个路由放入到另外的路由页面中。<br>另外项目中包含注册登录上传图片，所以需要数据库来存储这些数据，这个项目使用mongodb进行数据的存储。详细mongodb可自行查阅～</p>
<h4 id="安装mongoDB，配置项目数据库"><a href="#安装mongoDB，配置项目数据库" class="headerlink" title="安装mongoDB，配置项目数据库"></a>安装mongoDB，配置项目数据库</h4><p>1.下载mongodb<br><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">curl http:<span class="regexp">//</span>downloads.mongodb.org<span class="regexp">/osx/m</span>ongodb-osx-x86_64-<span class="number">2.4</span>.<span class="number">6</span>.tgz &gt; mongodb.tgz</span><br></pre></td></tr></table></figure></p>
<p>2.解压mongodb<br><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">tar</span> <span class="selector-tag">-zxvf</span> <span class="selector-tag">mongodb-osx-x86_64-2</span><span class="selector-class">.4</span><span class="selector-class">.6</span></span><br></pre></td></tr></table></figure></p>
<p>3.将解压的安装文件移动到想要存放的位置,我的是从Download移动到Applications的mongodb中<br><figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">mv -n ~<span class="regexp">/Downloads/m</span>ongodb-osx-x86_64-<span class="number">2.4</span>.<span class="number">6</span> ~<span class="regexp">/Applications/m</span>ongodb<span class="regexp">/</span></span><br></pre></td></tr></table></figure></p>
<p>4.在mongodb根目录下创建data/db目录，用于存放mongodb数据，并给改目录设置权限<br><figure class="highlight haskell"><table><tr><td class="code"><pre><span class="line"><span class="title">sudo</span> mkdir -p <span class="class"><span class="keyword">data</span>/db</span></span><br><span class="line"><span class="title">sudo</span> chown -<span class="type">R</span> zengjieyi /<span class="class"><span class="keyword">data</span></span></span><br></pre></td></tr></table></figure></p>
<p>5.启动mongodb<br><figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cd</span> bin</span><br><span class="line"><span class="string">./mongod</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/2017/04/18/基于react-nodejs-mongodb-webpack-redux实现图片上传应用/02.png" alt=""><br>6.进入mongodb shell,可直接编辑数据库<br> 打开另外一个终端<br> <figure class="highlight jboss-cli"><table><tr><td class="code"><pre><span class="line"><span class="keyword">cd</span> Applications/mongodb/bin</span><br><span class="line"><span class="string">./mongo</span></span><br></pre></td></tr></table></figure></p>
<p><img src="/2017/04/18/基于react-nodejs-mongodb-webpack-redux实现图片上传应用/03.png" alt=""><br>7.在uploader的项目中，创建database文件路径，建立models.js存放数据model，建立dbHandle.js，存放对数据的操作。<br><strong> models.js </strong><br><figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">//主要存储用户姓名、密码、上传的图片</span></span><br><span class="line">module.exports = &#123;</span><br><span class="line">    <span class="string">users :</span>&#123;</span><br><span class="line">        <span class="string">name :</span> &#123; <span class="string">type :</span> String , <span class="string">required :</span><span class="literal">true</span>&#125;,</span><br><span class="line">        <span class="string">password :</span> &#123; <span class="string">type :</span> String , <span class="string">required :</span> <span class="literal">true</span>&#125;,</span><br><span class="line">        <span class="string">imageUpload :</span> [&#123; <span class="string">imgUrl :</span> String , <span class="string">name :</span> String &#125;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong> dbHandle.js </strong><br><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//用于获取数据的操作</span></span><br><span class="line"><span class="keyword">var</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">var</span> Schema = mongoose.Schema;</span><br><span class="line"><span class="keyword">var</span> models = <span class="built_in">require</span>(<span class="string">'./models.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> m <span class="keyword">in</span> models)&#123;</span><br><span class="line">    mongoose.model(m,<span class="keyword">new</span> Schema(models[m]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    getModel : <span class="function"><span class="keyword">function</span>(<span class="params"><span class="keyword">type</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> _getModel(<span class="keyword">type</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> _getModel = <span class="function"><span class="keyword">function</span>(<span class="params"><span class="keyword">type</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mongoose.model(<span class="keyword">type</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>8.项目绑定数据库已在server.js添加<br><figure class="highlight lasso"><table><tr><td class="code"><pre><span class="line"><span class="comment">//mongoose数据库</span></span><br><span class="line">    <span class="built_in">global</span>.dbHandle = <span class="keyword">require</span>(<span class="string">'./database/dbHandle'</span>);</span><br><span class="line">    <span class="built_in">global</span>.db = mongoose.connect(<span class="string">"mongodb://localhost:27017/uploadimgdb"</span>);</span><br></pre></td></tr></table></figure></p>
<h4 id="建立项目路由"><a href="#建立项目路由" class="headerlink" title="建立项目路由"></a>建立项目路由</h4><p>这个项目根据需要csrf防御与否分为两个路由文件，index.js主要是登录、注册、退出登录、上传图片、获取图片、主页，checkIndex.js主要是判断是否登录、删除图片、主页。<br><strong> index.js </strong><br><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">var</span> formidable = <span class="built_in">require</span>(<span class="string">"formidable"</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">var</span> csrf = <span class="built_in">require</span>(<span class="string">'csurf'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册</span></span><br><span class="line">router.post(<span class="string">"/register"</span>,<span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> User = global.dbHandle.getModel(<span class="string">"users"</span>);</span><br><span class="line">    <span class="keyword">var</span> uname = req.body.uname,</span><br><span class="line">        upwd = req.body.upwd,</span><br><span class="line">        result = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    User.findOne(&#123;name : uname &#125;,<span class="function">(<span class="params">err , doc</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(err)&#123;</span><br><span class="line">            res.rend(<span class="number">500</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(doc)&#123;</span><br><span class="line">            res.send(<span class="number">501</span>);  <span class="comment">//用户名已经存在</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            User.create(&#123;</span><br><span class="line">                name : uname,</span><br><span class="line">                password : upwd</span><br><span class="line">            &#125;,<span class="function">(<span class="params">err , doc </span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(err)&#123;    </span><br><span class="line">                    res.send(<span class="number">500</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">var</span> user = <span class="built_in">JSON</span>.parse(<span class="built_in">JSON</span>.stringify(doc));</span><br><span class="line">                    req.session.user = user.name;</span><br><span class="line">                    res.send(<span class="number">200</span>);  <span class="comment">//注册成功</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//登陆</span></span><br><span class="line">router.post(<span class="string">"/login"</span>,<span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> User = global.dbHandle.getModel(<span class="string">'users'</span>),</span><br><span class="line">        uname = req.body.uname,</span><br><span class="line">        sess = req.session;</span><br><span class="line"></span><br><span class="line">    User.findOne(&#123;</span><br><span class="line">        name : uname</span><br><span class="line">    &#125;, <span class="function">(<span class="params">err,doc</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(err)&#123;    </span><br><span class="line">            res.sendStatus(<span class="number">500</span>);      <span class="comment">//登陆失败</span></span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(!doc)&#123;</span><br><span class="line">            res.sendStatus(<span class="number">404</span>);      <span class="comment">//用户名不存在</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(req.body.upwd != doc.password)&#123;</span><br><span class="line">                res.sendStatus(<span class="number">403</span>);      <span class="comment">//密码错误</span></span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">var</span> user = <span class="built_in">JSON</span>.parse(<span class="built_in">JSON</span>.stringify(doc));</span><br><span class="line">                sess.user = user.name;</span><br><span class="line">                res.sendStatus(<span class="number">200</span>);        <span class="comment">//登陆成功</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//退出登陆</span></span><br><span class="line">router.post(<span class="string">"/logout"</span>,<span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">    req.session.user = <span class="literal">null</span>;</span><br><span class="line">    req.session.imgUrl = <span class="literal">null</span>;</span><br><span class="line">    res.send(<span class="string">"200"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//上传图片</span></span><br><span class="line">router.post(<span class="string">"/upload"</span>,<span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> form = <span class="keyword">new</span> formidable.IncomingForm(),</span><br><span class="line">        targetDir = path.join(__dirname,<span class="string">"../public/uploadImages"</span>),</span><br><span class="line">        User = global.dbHandle.getModel(<span class="string">'users'</span>),</span><br><span class="line">        filesArr = [],</span><br><span class="line">        extName = <span class="string">''</span>,</span><br><span class="line">        times = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime(),</span><br><span class="line">        imgArr = req.session.imgArr == <span class="literal">undefined</span> ? [] : req.session.imgArr;</span><br><span class="line"></span><br><span class="line">    form.encoding = <span class="string">'utf-8'</span>;        <span class="comment">//设置编码</span></span><br><span class="line">    form.uploadDir = targetDir;     <span class="comment">//设置上传目录</span></span><br><span class="line">    form.keepExtensions = <span class="literal">true</span>;       <span class="comment">//保留后缀</span></span><br><span class="line">    form.maxFieldsSize = <span class="number">2</span>*<span class="number">1024</span>*<span class="number">1024</span>;       <span class="comment">//设置图片大小</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//检验存储上传的文件是否存在</span></span><br><span class="line">    fs.access(targetDir,<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(err)&#123;</span><br><span class="line">            fs.mkdirSync(targetDir);</span><br><span class="line">        &#125;</span><br><span class="line">        _fileParse();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">_fileParse</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        form.on(<span class="string">"file"</span>,<span class="function">(<span class="params">filed,file</span>) =&gt;</span> &#123;</span><br><span class="line">            filesArr.push(file);</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        form.parse(req, <span class="function">(<span class="params">err, fields, files</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(err)&#123;</span><br><span class="line">                res.locals.error = err;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">var</span> obj of filesArr)&#123;</span><br><span class="line">                <span class="keyword">var</span> filePath = obj.path,</span><br><span class="line">                    fileOleName = obj.name.substring(<span class="number">0</span>,obj.name.lastIndexOf(<span class="string">'.'</span>)),</span><br><span class="line">                    fileExt = filePath.substring(filePath.lastIndexOf(<span class="string">'.'</span>)),</span><br><span class="line">                    curTime = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime();</span><br><span class="line"></span><br><span class="line">                times = times == curTime ? (curTime+<span class="number">1</span>) : curTime;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> fileName = times + fileExt,</span><br><span class="line">                    targetFile = path.join(targetDir,fileName);</span><br><span class="line"></span><br><span class="line">                fs.renameSync(filePath, targetFile);</span><br><span class="line">                imgArr.push(&#123;imgUrl:<span class="string">`/public/uploadImages/<span class="subst">$&#123;fileName&#125;</span>`</span>,name:fileOleName &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            User.update(&#123;</span><br><span class="line">                name : req.session.user</span><br><span class="line">            &#125;,&#123;</span><br><span class="line">                imageUpload : imgArr</span><br><span class="line">            &#125;,<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(err)&#123;</span><br><span class="line">                    res.send(<span class="number">500</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            req.session.imgArr = imgArr;</span><br><span class="line">            res.sendStatus(<span class="number">200</span>);</span><br><span class="line">            <span class="comment">// res.redirect("/");</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取图片</span></span><br><span class="line">router.get(<span class="string">"/getImages"</span>,<span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> User = global.dbHandle.getModel(<span class="string">"users"</span>);</span><br><span class="line">    <span class="keyword">var</span> imgArr = req.session.imgArr == <span class="literal">undefined</span> ? [] : req.session.imgArr;</span><br><span class="line"></span><br><span class="line">    User.findOne(&#123;</span><br><span class="line">        name : req.session.user</span><br><span class="line">    &#125;,<span class="function">(<span class="params">err,doc</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(err)&#123;</span><br><span class="line">            res.send(<span class="number">404</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(doc)&#123;</span><br><span class="line">            doc = <span class="built_in">JSON</span>.parse(<span class="built_in">JSON</span>.stringify(doc));</span><br><span class="line">            <span class="keyword">if</span>(doc.imageUpload)&#123;</span><br><span class="line">                imgArr = doc.imageUpload;</span><br><span class="line">                req.session.imgArr = imgArr;</span><br><span class="line">                <span class="built_in">console</span>.log(imgArr);</span><br><span class="line">                res.json(imgArr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            res.json(imgArr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/"</span>,<span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> sess = req.session;</span><br><span class="line">    res.send(<span class="number">200</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure></p>
<p><strong> checkedIndex.js </strong><br><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">var</span> csrf = <span class="built_in">require</span>(<span class="string">'csurf'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//判断是否登陆</span></span><br><span class="line">router.get(<span class="string">"/isLogin"</span>,<span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> sess = req.session,</span><br><span class="line">        token = sess.token;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(sess.user)&#123;</span><br><span class="line">        token = token == <span class="literal">undefined</span> ? req.csrfToken() : token;</span><br><span class="line">        sess.token = token;</span><br><span class="line"></span><br><span class="line">        res.send(<span class="built_in">JSON</span>.stringify(&#123;code : <span class="number">200</span> , user : sess.user , token : token&#125;));</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        res.send(<span class="built_in">JSON</span>.stringify(&#123;code : <span class="number">403</span>&#125;))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//删除图片</span></span><br><span class="line">router.post(<span class="string">"/deleteImages"</span>,<span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> User = global.dbHandle.getModel(<span class="string">"users"</span>),</span><br><span class="line">        num = req.body.num,</span><br><span class="line">        imgArr = req.session.imgArr,</span><br><span class="line">        imgUrl = imgArr[num].imgUrl,</span><br><span class="line">        filePath = imgUrl.substring(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//本地文件删除</span></span><br><span class="line">    fs.unlink(filePath,<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(err)&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(err);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    imgArr.splice(num,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    User.update(&#123;</span><br><span class="line">        name : req.session.user</span><br><span class="line">    &#125;,&#123;</span><br><span class="line">        imageUpload : imgArr</span><br><span class="line">    &#125;,<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(err)&#123;</span><br><span class="line">            res.send(<span class="number">500</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            req.session.imgArr = imgArr;</span><br><span class="line">            res.send(<span class="number">200</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/"</span>,<span class="function">(<span class="params">req,res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> sess = req.session;</span><br><span class="line">    res.send(<span class="number">200</span>);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure></p>
<p>到这里node.js搭建服务器与相关后端接口已经差不多了，接下来开始搭建页面吧～～</p>
<h2 id="配置webpack"><a href="#配置webpack" class="headerlink" title="配置webpack"></a>配置webpack</h2><p>由于项目中使用到react和es6，需要webpack编译，在uploader目录下添加webpack.config.js文件<br><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;    </span><br><span class="line">    entry: <span class="string">'./src/index.js'</span>,</span><br><span class="line">    output: &#123;</span><br><span class="line">        filename: <span class="string">'./build/index.js'</span>,</span><br><span class="line">        publicPath : <span class="string">'/'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">module</span>: &#123;</span><br><span class="line">        loaders: [</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">                exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">                loader: <span class="string">'babel-loader?presets[]=es2015&amp;presets[]=react'</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>src/index.js为项目的编写react内容的主文件，此时需要在uploader目录下创建src文件夹并创建index.js。<br>项目中使用到webpack-dev-server的inline模式，需要修改package.json添加启动代码，将以下代码插入package.json中：<br><figure class="highlight prolog"><table><tr><td class="code"><pre><span class="line"><span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"start"</span>: <span class="string">"if-env NODE_ENV=production &amp;&amp; npm run start:prod || npm run start:dev"</span>,</span><br><span class="line">    <span class="string">"start:dev"</span>: <span class="string">"webpack-dev-server --inline --content-base . --histroy-api-fallback"</span>,</span><br><span class="line">    <span class="string">"start:prod"</span>: <span class="string">"webpack &amp;&amp; node server.js"</span></span><br><span class="line">  &#125;,</span><br><span class="line"><span class="string">"keywords"</span>: [</span><br><span class="line">    <span class="string">"react"</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>启动项目文件可以通过<code>npm run start:prod</code>命令。</p>
<h2 id="搭建页面"><a href="#搭建页面" class="headerlink" title="搭建页面"></a>搭建页面</h2><p>1.建立主页面<br>在uploader的目录下，创建index.html<br><strong> index.html </strong><br><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"zh-CN"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>基于React实现的前后端分离图片上传系统<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">type</span>=<span class="string">"text/css"</span> <span class="attr">href</span>=<span class="string">"./public/css/index.css"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span> <span class="attr">class</span>=<span class="string">"wrapper"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"./build/index.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>index.css为样式文件，此时需要在public创建css文件目录并在css中创建index.css样式文件。<br>index.js为webpack编译src/index.js后的文件。</p>
<p>2.引入redux，控制项目的数据状态<br>在redux中，Store用来存储数据，类似一个大的容器。State对象包含所有的数据，可以在某个点获取当时的数据。Action可以发出通知，让State发生变化。<br>在src文件夹内创建action文件目录和reducers文件目录分别存放对应的index.js。<br><strong> action/index.js </strong><br><figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> REQUEST_ISLOGIN = <span class="string">"REQUEST_ISLOGIN"</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> RECEIVE_LOGINED = <span class="string">"RECEIVE_LOGINED"</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> RECEIVE_NOT_LOGIN = <span class="string">"RECEIVE_NOT_LOGIN"</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> REQUEST_IMAGES = <span class="string">"REQUEST_IMAGES"</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> RECEIVE_IMAGES = <span class="string">"RECEIVE_IMAGES"</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> UPLOAD_IMAGES = <span class="string">"UPLOAD_IMAGES"</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> EXIT_LOGIN = <span class="string">"EXIT_LOGIN"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//退出登录操作</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> exitLogin = <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    <span class="keyword">type</span> : EXIT_LOGIN</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//判断是否登录前操作</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> requestIslogin = <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    <span class="keyword">type</span> : REQUEST_ISLOGIN</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//判断是否登录后，返回已登陆的操作，返回用户名跟唯一的token</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> receiveLogined = <span class="function"><span class="params">json</span> =&gt;</span> (&#123;</span><br><span class="line">    <span class="keyword">type</span> : RECEIVE_LOGINED,</span><br><span class="line">    user : json.user,</span><br><span class="line">    token : json.token</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//判断是否登录后，返回为登录的操作</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> receiveNotLogined = <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    <span class="keyword">type</span> : RECEIVE_NOT_LOGIN</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//请求图片前操作</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> requestImages = <span class="function"><span class="params">()</span> =&gt;</span> (&#123;</span><br><span class="line">    <span class="keyword">type</span> : REQUEST_IMAGES</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//请求图片后的操作，返回获取的图片</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> receiveImages = <span class="function"><span class="params">json</span> =&gt;</span> (&#123;</span><br><span class="line">    <span class="keyword">type</span> : RECEIVE_IMAGES,</span><br><span class="line">    images : json</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断是否登录</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> fetchIslogin = <span class="function"><span class="params">()</span> =&gt;</span> dispatch =&gt; &#123;</span><br><span class="line">    dispatch(requestIslogin())</span><br><span class="line">    <span class="keyword">return</span> fetch(<span class="string">"/isLogin"</span>,&#123;</span><br><span class="line">                method : <span class="string">"get"</span>,</span><br><span class="line">                credentials: <span class="string">'include'</span>,</span><br><span class="line">                header : &#123;</span><br><span class="line">                    <span class="string">"Content-Type"</span> : <span class="string">"application/json"</span></span><br><span class="line">                &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .then(<span class="function"><span class="params">res</span> =&gt;</span> res.json())</span><br><span class="line">        .then(<span class="function"><span class="params">json</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(json.code == <span class="number">200</span>)&#123;</span><br><span class="line">                dispatch(receiveLogined(json))</span><br><span class="line">                dispatch(requestImages())</span><br><span class="line">                <span class="keyword">return</span> fetch(<span class="string">"/getImages"</span>,&#123;</span><br><span class="line">                    method : <span class="string">"get"</span>,</span><br><span class="line">                    credentials: <span class="string">'include'</span>,</span><br><span class="line">                    header : &#123;</span><br><span class="line">                        <span class="string">"Content-Type"</span> : <span class="string">"application/json"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .then(<span class="function"><span class="params">res</span> =&gt;</span> res.json())</span><br><span class="line">                .then(<span class="function"><span class="params">json</span> =&gt;</span> dispatch(receiveImages(json)))</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                dispatch(receiveNotLogined())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//请求图片</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> fetchImages = <span class="function"><span class="params">()</span> =&gt;</span> dispatch =&gt; &#123;</span><br><span class="line">    dispatch(requestImages())</span><br><span class="line">    <span class="keyword">return</span> fetch(<span class="string">"/getImages"</span>,&#123;</span><br><span class="line">        method : <span class="string">"get"</span>,</span><br><span class="line">        credentials: <span class="string">'include'</span>,</span><br><span class="line">        header : &#123;</span><br><span class="line">            <span class="string">"Content-Type"</span> : <span class="string">"application/json"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(<span class="function"><span class="params">res</span> =&gt;</span> res.json())</span><br><span class="line">    .then(<span class="function"><span class="params">json</span> =&gt;</span> dispatch(receiveImages(json)))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//根据是否登录来能否请求图片</span></span><br><span class="line"><span class="keyword">const</span> shouldFetchImages = <span class="function"><span class="params">state</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> isLogin = state.user;</span><br><span class="line">    <span class="keyword">if</span>(isLogin.length &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//根据是否登录来能否请求图片</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> fetchImagesIfNeeded = <span class="function"><span class="params">()</span> =&gt;</span> (dispatch,getState) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(getState());</span><br><span class="line">    <span class="keyword">if</span>(shouldFetchImages(getState()))&#123;</span><br><span class="line">        <span class="keyword">return</span> dispatch(fetchImages())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//上传图片</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> uploadImages = <span class="function"><span class="params">images</span> =&gt;</span> (&#123;</span><br><span class="line">    <span class="keyword">type</span> : UPLOAD_IMAGES,</span><br><span class="line">    images</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>在这个项目中，需要从Store读取四个数据，分别是用户名user、csrf防御的token、用户的图片images，所以需要在reducers中合并输出这三个数据。<br><strong> reducers/index.js </strong><br><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">import &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">"redux"</span></span><br><span class="line">import &#123; REQUEST_ISLOGIN , RECEIVE_LOGINED , RECEIVE_NOT_LOGIN , REQUEST_IMAGES , RECEIVE_IMAGES , UPLOAD_IMAGES , EXIT_LOGIN&#125; <span class="keyword">from</span> <span class="string">"../actions"</span></span><br><span class="line"></span><br><span class="line">const<span class="built_in"> user </span>= (state = <span class="string">""</span>,action) =&gt; &#123;</span><br><span class="line">    switch(action.type)&#123;</span><br><span class="line">        case RECEIVE_LOGINED :</span><br><span class="line">            return action.user</span><br><span class="line">        case REQUEST_ISLOGIN :</span><br><span class="line">        case RECEIVE_NOT_LOGIN :</span><br><span class="line">        case EXIT_LOGIN : </span><br><span class="line">            return <span class="string">""</span>;</span><br><span class="line">       <span class="built_in"> default </span>:</span><br><span class="line">            return state</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const token = (<span class="attribute">state</span>=<span class="string">""</span>,action) =&gt; &#123;</span><br><span class="line">    switch(action.type)&#123;</span><br><span class="line">        case RECEIVE_LOGINED : </span><br><span class="line">            return action.token</span><br><span class="line">       <span class="built_in"> default </span>:</span><br><span class="line">            return state</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const images = (state = [] , action) =&gt; &#123;</span><br><span class="line">    switch(action.type)&#123;</span><br><span class="line">        case RECEIVE_IMAGES :</span><br><span class="line">            return [<span class="built_in">..</span>.state,<span class="built_in">..</span>.action.images]</span><br><span class="line">        case UPLOAD_IMAGES : </span><br><span class="line">        console.log(<span class="string">"length:"</span>,action.images);</span><br><span class="line">            return [<span class="built_in">..</span>.state,<span class="built_in">..</span>.action.images]</span><br><span class="line">        case REQUEST_IMAGES :</span><br><span class="line">       <span class="built_in"> default </span>:</span><br><span class="line">            return state</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const rootReducer = combineReducers(&#123;</span><br><span class="line">    user,</span><br><span class="line">    images,</span><br><span class="line">    token</span><br><span class="line">&#125;)</span><br><span class="line"><span class="builtin-name">export</span><span class="built_in"> default </span>rootReducer</span><br></pre></td></tr></table></figure></p>
<p>3.react组件化<br>项目中，页面分为注册、登录、主页三个页面，主页的组件分为头部组件、上传图片组件、图片列表组件。架构图如下：<br><img src="/2017/04/18/基于react-nodejs-mongodb-webpack-redux实现图片上传应用/04.png" alt=""><br>因此，添加以上文件与文件夹，uploader文件目录如下：<br><img src="/2017/04/18/基于react-nodejs-mongodb-webpack-redux实现图片上传应用/05.png" alt=""><br>页面代码如下：<br><strong> src/index.js </strong><br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">'react-dom'</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line"><span class="keyword">import</span> createLogger <span class="keyword">from</span> <span class="string">'redux-logger'</span></span><br><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">'redux-thunk'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./container/App'</span></span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">'./reducers'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> middleware = [ thunk ];</span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">  middleware.push(createLogger());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(</span><br><span class="line">  reducer,</span><br><span class="line">  applyMiddleware(...middleware)</span><br><span class="line">)</span><br><span class="line">render(</span><br><span class="line">    (</span><br><span class="line">        &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">            &lt;App /&gt;</span><br><span class="line">        &lt;<span class="regexp">/Provider&gt;</span></span><br><span class="line"><span class="regexp">    ),</span></span><br><span class="line"><span class="regexp">    document.getElementById('app')</span></span><br><span class="line"><span class="regexp">)</span></span><br></pre></td></tr></table></figure></p>
<p>在上面代码中，将store存入Provider，方便子组件获取数据。<br><strong> Container/App.js </strong><br><figure class="highlight coffeescript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Router, Route, hashHistory &#125; <span class="keyword">from</span> <span class="string">'react-router'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Home <span class="keyword">from</span> <span class="string">'../page/Home'</span>;</span><br><span class="line"><span class="keyword">import</span> Login <span class="keyword">from</span> <span class="string">'../page/Login'</span>;</span><br><span class="line"><span class="keyword">import</span> Register <span class="keyword">from</span> <span class="string">'../page/Register'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> React.createClass(&#123;</span><br><span class="line">    render()&#123;</span><br><span class="line">        <span class="keyword">return</span>   (</span><br><span class="line">            &lt;Router history=&#123;hashHistory&#125;&gt;</span><br><span class="line">                &lt;Route path=<span class="string">'/'</span> component=&#123;Home&#125; /&gt;            </span><br><span class="line">                &lt;Route path=<span class="string">'/login'</span> component=&#123;Login&#125;/&gt;</span><br><span class="line">                &lt;Route path=<span class="string">'/register'</span> component=&#123;Register&#125;/&gt;</span><br><span class="line">            &lt;/Router&gt;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>上面代码中，使用到Router设置三个页面的路由。<br><strong> Page/Register.js </strong><br><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React from <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Link &#125; from <span class="string">'react-router'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// components</span></span><br><span class="line"><span class="keyword">import</span> Login from <span class="string">'./Login'</span></span><br><span class="line"></span><br><span class="line">export <span class="keyword">default</span> React.createClass(&#123;</span><br><span class="line">    getInitialState() &#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            username : <span class="string">""</span>,</span><br><span class="line">            password : <span class="string">""</span>,</span><br><span class="line">            rePassword : <span class="string">""</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    handleChange(e) &#123;</span><br><span class="line">        <span class="keyword">var</span> newState = &#123;&#125;;</span><br><span class="line">        newState[e.target.name] = e.target.value;</span><br><span class="line">        <span class="keyword">this</span>.setState(newState);</span><br><span class="line">    &#125;,</span><br><span class="line">    contextTypes : &#123;</span><br><span class="line">        router : React.PropTypes.<span class="keyword">object</span></span><br><span class="line">    &#125;,</span><br><span class="line">    handleClick(e)&#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.state.username == <span class="literal">null</span> || <span class="keyword">this</span>.state.username == <span class="string">""</span>)&#123;</span><br><span class="line">            <span class="keyword">this</span>.refs.username.focus();</span><br><span class="line">            <span class="keyword">this</span>.showErr(<span class="string">"用户名不能为空"</span>,<span class="keyword">this</span>.refs.username);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.state.password == <span class="string">""</span>)&#123;</span><br><span class="line">            <span class="keyword">this</span>.refs.password.focus();</span><br><span class="line">            <span class="keyword">this</span>.showErr(<span class="string">"密码不能为空"</span>,<span class="keyword">this</span>.refs.password);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.state.rePassword == <span class="string">""</span>)&#123;</span><br><span class="line">            <span class="keyword">this</span>.refs.rePassword.focus();</span><br><span class="line">            <span class="keyword">this</span>.showErr(<span class="string">"确认密码不能为空"</span>,<span class="keyword">this</span>.refs.rePassword);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.state.password != <span class="keyword">this</span>.state.rePassword)&#123;</span><br><span class="line">            <span class="keyword">this</span>.showErr(<span class="string">"密码与确认密码不匹配"</span>,<span class="keyword">this</span>.refs.rePassword);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> <span class="keyword">data</span> = &#123;</span><br><span class="line">                <span class="string">"uname"</span> : <span class="keyword">this</span>.state.username,</span><br><span class="line">                <span class="string">"upwd"</span> :<span class="keyword">this</span>.state.password</span><br><span class="line">            &#125;;</span><br><span class="line">            fetch(<span class="string">'/register'</span>,&#123;</span><br><span class="line">                method : <span class="string">"post"</span>,</span><br><span class="line">                credentials: <span class="string">'include'</span>,</span><br><span class="line">                headers : &#123;</span><br><span class="line">                    <span class="string">'Content-Type'</span> : <span class="string">'application/json'</span></span><br><span class="line">                &#125;,</span><br><span class="line">                body : JSON.stringify(<span class="keyword">data</span>)</span><br><span class="line">            &#125;).then((res) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span>(res.ok)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.refs.err.innerHTML = <span class="string">"注册成功"</span>;</span><br><span class="line">                    setTimeout(() =&gt; &#123;</span><br><span class="line">                        <span class="keyword">this</span>.context.router.push(<span class="string">"/"</span>)</span><br><span class="line">                    &#125;,<span class="number">1000</span>)</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>(res.status == <span class="number">501</span>)&#123;</span><br><span class="line">                        <span class="keyword">this</span>.showErr(<span class="string">"用户名已经存在"</span>,<span class="keyword">this</span>.refs.username);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,(err) =&gt; &#123;</span><br><span class="line">                <span class="keyword">this</span>.refs.err(<span class="string">"注册失败"</span>);</span><br><span class="line">                <span class="keyword">this</span>.context.router.push(<span class="string">"/register"</span>)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    showErr(errStr,box)&#123;</span><br><span class="line">        <span class="keyword">var</span> that = <span class="keyword">this</span>;</span><br><span class="line">        that.refs.err.innerHTML = errStr;</span><br><span class="line">        box.onchange = function()&#123;</span><br><span class="line">            that.refs.err.innerHTML = <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div className=<span class="string">"box"</span>&gt;</span><br><span class="line">                &lt;form action=<span class="string">"/register"</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">                    &lt;h2&gt;注册页&lt;/h2&gt;</span><br><span class="line">                    &lt;ul&gt;</span><br><span class="line">                        &lt;li&gt;&lt;input name=<span class="string">"username"</span> ref=<span class="string">"username"</span> value=&#123;<span class="keyword">this</span>.state.uasername&#125; placeholder=<span class="string">"请输入用户名"</span> type=<span class="string">"text"</span> onChange=&#123;<span class="keyword">this</span>.handleChange&#125;/&gt;&lt;/li&gt;</span><br><span class="line">                        &lt;li&gt;&lt;input name=<span class="string">"password"</span> ref=<span class="string">"password"</span> value=&#123;<span class="keyword">this</span>.state.password&#125; placeholder=<span class="string">"请输入密码"</span> type=<span class="string">"password"</span> onChange=&#123;<span class="keyword">this</span>.handleChange&#125; /&gt;&lt;/li&gt;</span><br><span class="line">                        &lt;li&gt;&lt;input name=<span class="string">"rePassword"</span> ref=<span class="string">"rePassword"</span> value=&#123;<span class="keyword">this</span>.state.rePassword&#125; placeholder=<span class="string">"请再次输入密码"</span> type=<span class="string">"password"</span> onChange=&#123;<span class="keyword">this</span>.handleChange&#125; /&gt;&lt;/li&gt;</span><br><span class="line">                        &lt;li&gt;&lt;input name=<span class="string">"login"</span> value=<span class="string">"注册"</span> ref=<span class="string">"login"</span> type=<span class="string">"submit"</span> onClick=&#123;<span class="keyword">this</span>.handleClick&#125; className=<span class="string">"box_btn"</span> /&gt; &lt;/li&gt;</span><br><span class="line">                        &lt;li&gt;&lt;p className=<span class="string">"err"</span> ref=<span class="string">"err"</span>&gt;&lt;/p&gt;&lt;/li&gt;</span><br><span class="line">                    &lt;/ul&gt;                 </span><br><span class="line">                &lt;/form&gt;</span><br><span class="line">                &lt;ul className=<span class="string">"go"</span>&gt;</span><br><span class="line">                    &lt;li className=<span class="string">"other"</span>&gt;&lt;Link to=<span class="string">"/"</span> &gt;主页&lt;/Link&gt;&lt;/li&gt;</span><br><span class="line">                    &lt;li className=<span class="string">"other"</span>&gt;&lt;Link to=<span class="string">"Login"</span> &gt;登陆&lt;/Link&gt;&lt;/li&gt;</span><br><span class="line">                &lt;/ul&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p>在上面代码中，注册使用了register接口，注意需要fetch中添加<code>credentials: &#39;include&#39;</code>，因为fetch不会添加cookie到服务器，这个配置就是将cookie添加保存到服务器。</p>
<p><strong> page/Login.js </strong><br><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React from <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Link &#125; from <span class="string">'react-router'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// components</span></span><br><span class="line"><span class="keyword">import</span> Register from <span class="string">'./Register'</span></span><br><span class="line"><span class="keyword">import</span> Home from <span class="string">'./Home'</span></span><br><span class="line"></span><br><span class="line">export <span class="keyword">default</span> React.createClass(&#123;</span><br><span class="line">    getInitialState()&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            username : <span class="string">""</span>,</span><br><span class="line">            password : <span class="string">""</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    showErr(errStr,box)&#123;</span><br><span class="line">        let that = <span class="keyword">this</span>;</span><br><span class="line">        that.refs.err.innerHTML = errStr;</span><br><span class="line">        box.onchange = function()&#123;</span><br><span class="line">            that.refs.err.innerHTML = <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    handleChange(e)&#123;</span><br><span class="line">        <span class="keyword">var</span> newState = &#123;&#125;;</span><br><span class="line">        newState[e.target.name] = e.target.value;</span><br><span class="line">        <span class="keyword">this</span>.setState(newState);</span><br><span class="line">    &#125;,</span><br><span class="line">    contextTypes : &#123;</span><br><span class="line">        router : React.PropTypes.<span class="keyword">object</span></span><br><span class="line">    &#125;,</span><br><span class="line">    handleClick(e)&#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.state.username == <span class="string">""</span> || <span class="keyword">this</span>.state.username == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">this</span>.refs.username.focus();</span><br><span class="line">            <span class="keyword">this</span>.showErr(<span class="string">"用户名不能为空"</span>,<span class="keyword">this</span>.refs.username);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="keyword">this</span>.state.password == <span class="string">""</span>)&#123;</span><br><span class="line">            <span class="keyword">this</span>.refs.password.focus();</span><br><span class="line">            <span class="keyword">this</span>.showErr(<span class="string">"密码不能为空"</span>,<span class="keyword">this</span>.refs.password);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            let <span class="keyword">data</span> = &#123;</span><br><span class="line">                <span class="string">"uname"</span> : <span class="keyword">this</span>.state.username,</span><br><span class="line">                <span class="string">"upwd"</span> : <span class="keyword">this</span>.state.password</span><br><span class="line">            &#125;</span><br><span class="line">            fetch(<span class="string">'/login'</span>,&#123;</span><br><span class="line">                method : <span class="string">"post"</span>,</span><br><span class="line">                credentials: <span class="string">'include'</span>,</span><br><span class="line">                headers : &#123;</span><br><span class="line">                    <span class="string">'Content-Type'</span> : <span class="string">'application/json'</span></span><br><span class="line">                &#125;,</span><br><span class="line">                body : JSON.stringify(<span class="keyword">data</span>)</span><br><span class="line">            &#125;).then((res) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span>(res.ok)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.refs.err.innerHTML = <span class="string">"登陆成功！"</span>;</span><br><span class="line">                    <span class="keyword">this</span>.context.router.push(<span class="string">"/"</span>);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>(res.status == <span class="number">404</span>)&#123;</span><br><span class="line">                        <span class="keyword">this</span>.refs.username.focus();</span><br><span class="line">                        <span class="keyword">this</span>.showErr(<span class="string">"用户名不存在！"</span>,<span class="keyword">this</span>.refs.username);</span><br><span class="line">                    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(res.status == <span class="number">403</span>)&#123;</span><br><span class="line">                        <span class="keyword">this</span>.refs.password.focus();</span><br><span class="line">                        <span class="keyword">this</span>.showErr(<span class="string">"密码错误"</span>,<span class="keyword">this</span>.refs.password);</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="keyword">this</span>.showErr(<span class="string">"登陆失败"</span>,<span class="keyword">this</span>.refs.username);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,(err) =&gt; &#123;</span><br><span class="line">                <span class="keyword">this</span>.showErr(<span class="string">"登陆失败"</span>,<span class="keyword">this</span>.refs.username);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;div className=<span class="string">"box"</span>&gt;</span><br><span class="line">                &lt;form action=<span class="string">"login"</span> method=<span class="string">"POST"</span>&gt;</span><br><span class="line">                    &lt;h2&gt;登录页&lt;/h2&gt;</span><br><span class="line">                    &lt;ul&gt;</span><br><span class="line">                        &lt;li&gt;&lt;input name=<span class="string">"username"</span> ref=<span class="string">"username"</span> value=&#123;<span class="keyword">this</span>.state.username&#125; placeholder=<span class="string">"请输入用户名"</span> type=<span class="string">"text"</span> onChange=&#123;<span class="keyword">this</span>.handleChange&#125; /&gt;&lt;/li&gt;</span><br><span class="line">                        &lt;li&gt;&lt;input name=<span class="string">"password"</span> ref=<span class="string">"password"</span> value=&#123;<span class="keyword">this</span>.state.password&#125; placeholder=<span class="string">"请输入密码"</span> type=<span class="string">"password"</span> onChange=&#123;<span class="keyword">this</span>.handleChange&#125; /&gt;&lt;/li&gt;</span><br><span class="line">                        &lt;li&gt;&lt;input name=<span class="string">"login"</span> ref=<span class="string">"login"</span> value=<span class="string">"登录"</span> type=<span class="string">"submit"</span> onClick=&#123;<span class="keyword">this</span>.handleClick&#125; className=<span class="string">"box_btn"</span> /&gt; &lt;/li&gt;</span><br><span class="line">                        &lt;li&gt;&lt;p ref=<span class="string">"err"</span> className=<span class="string">"err"</span>&gt;&lt;/p&gt;&lt;/li&gt; </span><br><span class="line">                    &lt;/ul&gt;                  </span><br><span class="line">                &lt;/form&gt;</span><br><span class="line">                &lt;ul className=<span class="string">"go"</span>&gt;</span><br><span class="line">                    &lt;li className=<span class="string">"other"</span>&gt;&lt;Link to=<span class="string">"/"</span> &gt;主页&lt;/Link&gt;&lt;/li&gt;</span><br><span class="line">                    &lt;li className=<span class="string">"other"</span>&gt;&lt;Link to=<span class="string">"Register"</span> &gt;注册&lt;/Link&gt;&lt;/li&gt;</span><br><span class="line">                &lt;/ul&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<p><strong> components/Header.js </strong><br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Link &#125; <span class="keyword">from</span> <span class="string">'react-router'</span>;</span><br><span class="line"><span class="keyword">import</span> React, &#123; Component, PropTypes &#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> React.createClass (&#123;</span><br><span class="line">    contextTypes : &#123;</span><br><span class="line">        router : React.PropTypes.object</span><br><span class="line">    &#125;,</span><br><span class="line">    logout(e)&#123;</span><br><span class="line">        <span class="keyword">let</span> &#123; exitLogin &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">        e.preventDefault();</span><br><span class="line">        fetch(<span class="string">"/logout"</span>,&#123;</span><br><span class="line">            method : <span class="string">"post"</span>,</span><br><span class="line">            credentials: <span class="string">'include'</span>,</span><br><span class="line">            header : &#123;</span><br><span class="line">                <span class="string">"Content-Type"</span> : <span class="string">"application/json"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(res.ok)&#123;</span><br><span class="line">                exitLogin();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;,</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;header&gt;</span><br><span class="line">                &lt;h1&gt;<span class="xml"><span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">"/"</span>&gt;</span>基于React实现的前后端分离图片上传系统<span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">                &lt;nav&gt;                     </span><br><span class="line">                    &#123; <span class="keyword">this</span>.props.user != <span class="string">""</span> ? <span class="keyword">this</span>.renderLoginedBtn() : <span class="keyword">this</span>.renderNotLoginBtn() &#125;</span><br><span class="line">                &lt;<span class="regexp">/nav&gt;</span></span><br><span class="line"><span class="regexp">            &lt;/</span>header&gt;</span><br><span class="line">        )</span><br><span class="line">    &#125;,</span><br><span class="line">    renderNotLoginBtn() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;ul&gt;</span><br><span class="line">                &lt;li&gt;<span class="xml"><span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">"/Login"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">                &lt;li&gt;<span class="xml"><span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">"/Register"</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">Link</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">            &lt;<span class="regexp">/ul&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;,</span></span><br><span class="line"><span class="regexp">    renderLoginedBtn(name) &#123;</span></span><br><span class="line"><span class="regexp">        return (</span></span><br><span class="line"><span class="regexp">            &lt;ul&gt;    </span></span><br><span class="line"><span class="regexp">                &lt;li&gt;&lt;p className="name"&gt;&#123;this.props.user&#125;&lt;/</span>p&gt;<span class="xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">                &lt;li&gt;<span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"javascript:;"</span> <span class="attr">onClick</span>=<span class="string">&#123;this.logout&#125;</span>&gt;</span>退出<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><span class="xml"><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line">            &lt;<span class="regexp">/ul&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br></pre></td></tr></table></figure></p>
<p>在上面代码中，需要根据登录与否修改状态，如已登录，显示用户名。</p>
<p><strong> components/Upload.js </strong><br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> React.createClass(&#123;</span><br><span class="line">    contextTypes : &#123;</span><br><span class="line">        router : React.PropTypes.object</span><br><span class="line">    &#125;,</span><br><span class="line">    handleUpload(e) &#123;</span><br><span class="line">        <span class="keyword">let</span> isAllImage = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">let</span> &#123; uploadFuc &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">        <span class="comment">//判断是否都是图片</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> val <span class="keyword">of</span> <span class="keyword">this</span>.refs.upload.files)&#123;</span><br><span class="line">            <span class="keyword">let</span> _type = val.type;</span><br><span class="line">            <span class="keyword">if</span>(!_type.includes(<span class="string">"image"</span>))&#123;</span><br><span class="line">                isAllImage = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">this</span>.showErr(<span class="string">"只能上传图片"</span>,<span class="number">3000</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//全是图片</span></span><br><span class="line">        <span class="keyword">if</span>(isAllImage)&#123;</span><br><span class="line">            <span class="keyword">this</span>.refs.formupload.submit();</span><br><span class="line">            setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">                location.reload();</span><br><span class="line">            &#125;,<span class="number">500</span>)</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    showErr(errStr,time)&#123;</span><br><span class="line">        <span class="keyword">this</span>.refs.err.innerHTML = errStr;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.refs.err.innerHTML = <span class="string">""</span>;</span><br><span class="line">        &#125;,time)</span><br><span class="line">    &#125;,</span><br><span class="line">    uploadForm() &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            &lt;section className=<span class="string">"col col_left"</span>&gt;</span><br><span class="line">                &lt;div className=<span class="string">"upload_wrap"</span>&gt;</span><br><span class="line">                    &lt;em&gt;上传图片&lt;<span class="regexp">/em&gt;</span></span><br><span class="line"><span class="regexp">                    &lt;form action="/u</span>pload<span class="string">" method="</span>POST<span class="string">" encType="</span>multipart/form-data<span class="string">" role="</span>form<span class="string">" ref="</span>formupload<span class="string">" target="</span>showResult<span class="string">"&gt;</span></span><br><span class="line"><span class="string">                        &lt;input type="</span>file<span class="string">" multiple="</span>multiple<span class="string">" accept="</span>image<span class="comment">/*" ref="upload" name="upload" className="upload" onChange=&#123;this.handleUpload&#125; /&gt;</span></span><br><span class="line"><span class="comment">                    &lt;/form&gt;</span></span><br><span class="line"><span class="comment">                    &lt;p className="err" ref="err"&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="comment">                    &lt;iframe ref="showResult" className="result" name="showResult"&gt;&lt;/iframe&gt;</span></span><br><span class="line"><span class="comment">                &lt;/div&gt;</span></span><br><span class="line"><span class="comment">            &lt;/section&gt;</span></span><br><span class="line"><span class="comment">        )</span></span><br><span class="line"><span class="comment">    &#125;,</span></span><br><span class="line"><span class="comment">    render() &#123;</span></span><br><span class="line"><span class="comment">        let &#123; user &#125;  = this.props;</span></span><br><span class="line"><span class="comment">        return user.length &gt; 0 ? this.uploadForm() : (&lt;p&gt;&lt;/p&gt;);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">&#125;)</span></span><br></pre></td></tr></table></figure></p>
<p>在上面代码中，由于node.js使用了formidable模块，页面中，只需要submit即可。</p>
<p><strong> components/Images.js </strong><br><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> React.createClass(&#123;</span><br><span class="line">    handleCopy(e)&#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> parent = e.target.parentNode,</span><br><span class="line">            item_act_input = parent.querySelector(<span class="string">".item_act_input"</span>),</span><br><span class="line">            range = <span class="built_in">document</span>.createRange();</span><br><span class="line"></span><br><span class="line">        item_act_input.innerHTML = <span class="string">`<span class="subst">$&#123;location.host&#125;</span><span class="subst">$&#123;item_act_input.innerHTML&#125;</span>`</span>;</span><br><span class="line">        range.selectNode(item_act_input);</span><br><span class="line">        <span class="built_in">window</span>.getSelection().addRange(range);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> copy = <span class="built_in">document</span>.execCommand(<span class="string">'copy'</span>);</span><br><span class="line">        alert(<span class="string">"复制成功"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    handleDelete(e)&#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line">        <span class="keyword">var</span> num = e.target.getAttribute(<span class="string">"data-id"</span>),</span><br><span class="line">            url = <span class="string">"/deleteImages"</span>,</span><br><span class="line">            parents = e.target.parentNode.parentNode,</span><br><span class="line">            token = <span class="keyword">this</span>.props.token;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> isDelete = confirm(<span class="string">"确定删除这张图片吗？"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(isDelete)&#123;</span><br><span class="line">            fetch(url,&#123;</span><br><span class="line">                method : <span class="string">"POST"</span>,</span><br><span class="line">                credentials: <span class="string">'include'</span>,</span><br><span class="line">                headers : &#123;</span><br><span class="line">                    <span class="string">'Content-Type'</span> : <span class="string">'application/json'</span>,</span><br><span class="line">                    <span class="string">'X-CSRF-Token'</span>: token</span><br><span class="line">                &#125;,</span><br><span class="line">                body : <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">                    num : num</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(res.ok)&#123;</span><br><span class="line">                    <span class="keyword">this</span>.refs.imgbox.removeChild(parents);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    render() &#123;</span><br><span class="line">        <span class="keyword">let</span> &#123; imageList &#125; = <span class="keyword">this</span>.props;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> imageList.length &lt;= <span class="number">0</span> ? (<span class="xml"><span class="tag">&lt;<span class="name">section</span> <span class="attr">className</span>=<span class="string">"col col_right"</span>&gt;</span><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span>) : (</span><br><span class="line">            &lt;section className=<span class="string">"col col_right"</span>&gt;</span><br><span class="line">                &lt;ul ref=<span class="string">"imgbox"</span>&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        imageList.map( <span class="function">(<span class="params">image, i</span>) =&gt;</span> &#123;</span><br><span class="line">                            <span class="keyword">return</span> (</span><br><span class="line">                                &lt;li key=&#123;i&#125; className=<span class="string">"item"</span>&gt;</span><br><span class="line">                                    &lt;div className=<span class="string">"item_img"</span>&gt;</span><br><span class="line">                                        &lt;img src=&#123;image.imgUrl&#125; alt=&#123;image.name&#125;/&gt;</span><br><span class="line">                                    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">                                    &lt;div className="item_desc"&gt;</span></span><br><span class="line"><span class="regexp">                                        &lt;p&gt;&#123;image.name&#125;&lt;/</span>p&gt;</span><br><span class="line">                                    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">                                    &lt;div className="item_act"&gt;</span></span><br><span class="line"><span class="regexp">                                        &lt;p className="hide item_act_input" &gt;&#123;image.imgUrl&#125;&lt;/</span>p&gt;</span><br><span class="line">                                        &lt;a href=&#123;image.imgUrl&#125; className=<span class="string">"item_act_copy"</span>  onClick=&#123;<span class="keyword">this</span>.handleCopy&#125;&gt;复制链接&lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp">                                        &lt;a href=&#123;image.imgUrl&#125; target="_blank" &gt;打开&lt;/</span>a&gt;</span><br><span class="line">                                        &lt;a href=&#123;image.imgUrl&#125; onClick=&#123;<span class="keyword">this</span>.handleDelete&#125; data-id=&#123;i&#125; &gt;删除&lt;<span class="regexp">/a&gt;</span></span><br><span class="line"><span class="regexp">                                    &lt;/</span>div&gt;</span><br><span class="line">                                &lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">                            )</span></span><br><span class="line"><span class="regexp">                        &#125;)</span></span><br><span class="line"><span class="regexp">                    &#125;</span></span><br><span class="line"><span class="regexp">                &lt;/u</span>l&gt;</span><br><span class="line">            &lt;<span class="regexp">/section&gt;</span></span><br><span class="line"><span class="regexp">        )</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br></pre></td></tr></table></figure></p>
<p>在上面的代码中，通过父级组件的props获取全部的图片，进行遍历渲染出来。</p>
<p>到这里，已经完成全部的功能，可以通过<code>npm run start:prod</code>启动项目，通过<a href="localhost:9990" target="_blank" rel="noopener">localhost:9990</a>预览项目。<br>需要代码的可移步至Github:<a href="https://github.com/ggstudy-ddup/react-pic-uploader/tree/master/demo" target="_blank" rel="noopener">源码</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2017/05/25/sprite雪碧图生成方法/" class="prev">上一篇</a><a href="/2016/09/15/讲讲es6那些事/" class="next">下一篇</a></div><div data-thread-key="2017/04/18/基于react-nodejs-mongodb-webpack-redux实现图片上传应用/" data-title="基于react+nodejs+mongodb+webpack+redux实现图片上传应用" data-url="http://zengzoe.github.io/2017/04/18/基于react-nodejs-mongodb-webpack-redux实现图片上传应用/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"zengzoe"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2016 - 2018 <a href="http://zengzoe.github.io">Zeng Zoe</a>, unless otherwise noted.</p><p style="display:none !important;"><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span><span id="busuanzi_container_site_uv">本站总访客数<span id="busuanzi_value_site_uv"></span>人次</span></p></div></footer><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>