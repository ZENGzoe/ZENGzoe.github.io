<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 如何用Phaser实现一个全家福拼图H5 · 曾洁仪博客</title><meta name="description" content="如何用Phaser实现一个全家福拼图H5 - Zeng Zoe"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="css/googleapisFonts.css" type="text/css"></head><body><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/zengjieyi1994" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/ZENGzoe" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li></ul></header><section class="container"><div class="post"><span style="display:none !important;"><span id="busuanzi_container_page_pv">本文总阅读量<span id="busuanzi_value_page_pv"></span></span></span><article class="post-block"><h1 class="post-title">如何用Phaser实现一个全家福拼图H5</h1><div class="post-time">2019年1月23日</div><div class="post-content"><p><img src="/2019/01/24/如何用Phaser实现一个全家福拼图h5/02.jpg" alt=""></p>
<p><a href="# 一、Phaser介绍">一、Phaser介绍</a><br><a href="# 二、整体框架搭建">二、整体框架搭建</a><br><a href="# 三、资源加载">三、资源加载</a><br><a href="# 四、游戏逻辑">四、游戏逻辑</a><br><a href="# 五、完成">五、完成</a><br><a href="# 六、总结">六、总结</a><br><a href="# 参考文档">参考文档</a></p>
<p>最近用Phaser做了一个全家福拼图h5的项目，这篇文章将会从零开始讲解如何用Phaser实现，最终效果如下：</p>
<p><img src="/2019/01/24/如何用Phaser实现一个全家福拼图h5/01.gif" alt=""></p>
<p><br></p>
<p><a href="https://github.com/ZENGzoe/phaser-puzzle.git" target="_blank" rel="noopener">源码：https://github.com/ZENGzoe/phaser-puzzle.git</a><br><a href="https://zengzoe.github.io/phaser-puzzle/dist/">demo：https://zengzoe.github.io/phaser-puzzle/dist/</a><br><img src="/2019/01/24/如何用Phaser实现一个全家福拼图h5/07.png" alt=""></p>
<h1 id="一、Phaser介绍"><a href="#一、Phaser介绍" class="headerlink" title="一、Phaser介绍"></a>一、Phaser介绍</h1><p>Phaser是一个开源的HTML5游戏框架，支持桌面和移动HTML5游戏，支持Canvas和WebGL渲染。官方文档齐全，上手也比较容易。</p>
<p>Phaser的功能主要还有预加载、物理引擎、图片精灵、群组、动画等。</p>
<p><img src="/2019/01/24/如何用Phaser实现一个全家福拼图h5/03.png" alt=""></p>
<p>更多详细内容可以查看<a href="https://phaser.io" target="_blank" rel="noopener">Phaser官网</a>，我的学习过程是主要是边看<a href="https://phaser.io/examples" target="_blank" rel="noopener">Phaser案例</a>的实现，边看<a href="https://www.phaser-china.com/docs/Index.html" target="_blank" rel="noopener">API文档</a>查看用法。</p>
<h1 id="二、整体框架搭建"><a href="#二、整体框架搭建" class="headerlink" title="二、整体框架搭建"></a>二、整体框架搭建</h1><h4 id="1-目录结构"><a href="#1-目录结构" class="headerlink" title="1.目录结构"></a>1.目录结构</h4><p>目录初始结构如下:</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── package<span class="selector-class">.json</span>            </span><br><span class="line">├── postcss<span class="selector-class">.config</span><span class="selector-class">.js</span>           <span class="comment">//postcss配置</span></span><br><span class="line">├── src                         <span class="comment">//主要代码目录</span></span><br><span class="line">│   ├── css</span><br><span class="line">│   ├── img</span><br><span class="line">│   ├── index.html</span><br><span class="line">│   ├── js  </span><br><span class="line">│   │   └── index<span class="selector-class">.js</span>            <span class="comment">//入口文件</span></span><br><span class="line">│   ├── json                    <span class="comment">//json文件目录</span></span><br><span class="line">│   ├── lib                     <span class="comment">//其他库</span></span><br><span class="line">│   └── sprite                  <span class="comment">//sprite雪碧图合成目录</span></span><br><span class="line">├── webpack<span class="selector-class">.config</span><span class="selector-class">.build</span><span class="selector-class">.js</span>     <span class="comment">//webpack生成distw文件配置</span></span><br><span class="line">└── webpack<span class="selector-class">.config</span><span class="selector-class">.dev</span><span class="selector-class">.js</span>       <span class="comment">//webpack编译配置</span></span><br></pre></td></tr></table></figure>
<p>项目的构建工具使用的是Webpack， Webpack的配置可以查看源码<a href="">webapck.config.dev.js</a>，为避免文章篇幅过长，这里将不会详细介绍Webpack的配置过程，Webpck的配置介绍可以查看Webpack的官方文档<a href="https://webpack.github.io/" target="_blank" rel="noopener">https://webpack.github.io/</a>。</p>
<p><br></p>
<h4 id="2-创建游戏"><a href="#2-创建游戏" class="headerlink" title="2.创建游戏"></a>2.创建游戏</h4><h5 id="（1）库引入"><a href="#（1）库引入" class="headerlink" title="（1）库引入"></a>（1）库引入</h5><p>在<code>index.html</code>引入Phaser官网下载的Phaser库。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"js/phaser.min.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="（2）创建游戏"><a href="#（2）创建游戏" class="headerlink" title="（2）创建游戏"></a>（2）创建游戏</h5><p>Phaser中通过<code>Phaser.Game</code>来创建游戏界面，也是游戏的核心。可以通过创建的这个游戏对象，添加更多生动的东西。</p>
<p><code>Phaser.Game(width, height, renderer, parent, state, transparent, antialias, physicsConfig)</code>有八个参数：</p>
<p><code>width</code> ：游戏界面宽度，默认值为800。<br><code>height</code> ：游戏界面高度，默认值为600。<br><code>renderer</code> ：游戏渲染器，默认值为<code>Phaser.AUTO</code>，随机选择其他值：<code>Phaser.WEBGL</code>、<code>Phaser.CANVAS</code>、<code>Phaser.HEADLESS</code>（不进行渲染）。<br><code>parent</code> ：游戏界面挂载的DOM节点，可以为DOM id，或者标签。<br><code>state</code> ：游戏state对象，默认值为null，游戏的state对象一般包含方法（preload、create、update、render）。<br><code>transparent</code> ：是否设置游戏背景为透明，默认值为false。<br><code>antialias</code> ：是否显示图片抗锯齿。默认值为true。<br><code>physicsConfig</code> ：游戏物理引擎配置。<br><figure class="highlight dart"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//index.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//以750宽度视觉搞为准</span></span><br><span class="line"><span class="comment">//选择是canvas渲染方式</span></span><br><span class="line"><span class="built_in">window</span>.customGame = <span class="keyword">new</span> Phaser.Game(<span class="number">750</span> , <span class="number">750</span> / <span class="built_in">window</span>.innerWidth * <span class="built_in">window</span>.innerHeight , Phaser.CANVAS , <span class="string">'container'</span>);</span><br></pre></td></tr></table></figure></p>
<figure class="highlight axapta"><table><tr><td class="code"><pre><span class="line"><span class="comment">//index.html</span></span><br><span class="line">&lt;<span class="keyword">div</span> id=<span class="string">"container"</span>&gt;&lt;/<span class="keyword">div</span>&gt;</span><br></pre></td></tr></table></figure>
<p>这样就可以在页面上看到我们的Canvas界面。</p>
<h4 id="3-功能划分"><a href="#3-功能划分" class="headerlink" title="3.功能划分"></a>3.功能划分</h4><p>在项目中，为了将项目模块化，将加载资源逻辑和游戏逻辑分开，在<code>src/js</code>中新建<code>load.js</code>存放加载资源逻辑，新建<code>play.js</code>存放游戏逻辑。在这里的两个模块以游戏场景的形式存在。</p>
<p>场景（state）在Phaser中是可以更快地获取公共函数，比如camera、cache、input等，表现形式为js自定义对象或者函数存在，只要存在preload、create、update这三个方法中地任意一个，就是一个Phaser场景。</p>
<p>在Phaser场景中，总共有五个方法：<code>init</code>、<code>preload</code>、<code>create</code>、<code>update</code>、<code>render</code>。前三个的执行循序为：init =&gt; preload =&gt; create。</p>
<p><code>init</code> ：在场景中是最先执行的方法，可以在这里添加场景的初始化。</p>
<p><code>preload</code> ：这个方法在init后触发，如果没有init，则第一个执行，一般在这里进行资源的加载。</p>
<p><code>create</code> ：这个方法在preload后触发，这里可以使用预加载中的资源。</p>
<p><code>update</code> ：这是每一帧都会执行一次的更新方法。</p>
<p><code>render</code> ：这是在每次物件渲染之后都会执行渲染方法。</p>
<p>用户自定义场景可以通过<code>game.state.add</code>方法添加到游戏中，如在项目中，需要将预加载模块和游戏逻辑模块加入到游戏中：</p>
<figure class="highlight pf"><table><tr><td class="code"><pre><span class="line">//index.js</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">const <span class="built_in">load</span> = require('./<span class="built_in">load</span>');</span><br><span class="line">const play = require('./play');</span><br><span class="line"></span><br><span class="line">customGame.<span class="keyword">state</span>.add('Load' , <span class="built_in">load</span>);</span><br><span class="line">customGame.<span class="keyword">state</span>.add('Play' , play);</span><br></pre></td></tr></table></figure>
<p><code>game.state.add</code>第一个参数为场景命名，第二个参数为场景。</p>
<p>此时我的游戏场景就有Load和Play。游戏中首先要执行的是Load场景，可以通过<code>game.state.start</code>方法来开始执行Load场景。</p>
<figure class="highlight pf"><table><tr><td class="code"><pre><span class="line">//index.js</span><br><span class="line"></span><br><span class="line">customGame.<span class="keyword">state</span>.start('Load');</span><br></pre></td></tr></table></figure>
<p><br></p>
<h1 id="三、资源加载"><a href="#三、资源加载" class="headerlink" title="三、资源加载"></a>三、资源加载</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//load.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> load = &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">module</span>.<span class="keyword">exports</span> = load;</span><br></pre></td></tr></table></figure>
<h4 id="1-画面初始化"><a href="#1-画面初始化" class="headerlink" title="1.画面初始化"></a>1.画面初始化</h4><p>进入页面前，需要进行一些游戏画面的初始化。在这里进行初始化的原因在于在场景里才能使用一些设置的方法。</p>
<h5 id="（1）添加画布背景色"><a href="#（1）添加画布背景色" class="headerlink" title="（1）添加画布背景色"></a>（1）添加画布背景色</h5><figure class="highlight 1c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//load.js</span></span><br><span class="line">customGame.stage.backgroundColor = '#4f382b';</span><br></pre></td></tr></table></figure>
<h5 id="（2）设置屏幕适配模式"><a href="#（2）设置屏幕适配模式" class="headerlink" title="（2）设置屏幕适配模式"></a>（2）设置屏幕适配模式</h5><p>由于不同设备屏幕尺寸不同，需要根据需求设置适合的适配模式。可通过<code>game.scale.scaleMode</code>设置适配模式，适配模式<code>Phaser.ScaleManager</code>有五种：</p>
<p><code>NO_SCALE</code> ：不进行任何缩放</p>
<p><code>EXACT_FIT</code> ：对画面进行拉伸撑满屏幕，比例发生变化，会有缩放变形的情况</p>
<p><code>SHOW_ALL</code> ：在比例不变、缩放不变形的基础上显示所有的内容，通常使用这种模式</p>
<p><code>RESIZE</code> ：适配画面的宽度不算高度，不进行缩放，不变形</p>
<p><code>USER_SCALE</code> ： 根据用户的设置变形</p>
<p>在这里的适配模式选择的是<code>SHOW_ALL</code>：</p>
<figure class="highlight gauss"><table><tr><td class="code"><pre><span class="line"><span class="comment">//load.js</span></span><br><span class="line">customGame.<span class="built_in">scale</span>.scaleMode = Phaser.ScaleManager.SHOW_ALL;</span><br></pre></td></tr></table></figure>
<h4 id="2-资源预加载"><a href="#2-资源预加载" class="headerlink" title="2.资源预加载"></a>2.资源预加载</h4><p>Phaser中通过<code>game.load</code>进行加载资源的预加载，预加载的资源可以为图片、音频、视频、雪碧图等等，这个游戏的资源只有普通图片和雪碧图，其他类型的加载方式可查看<a href="https://www.phaser-china.com/docs/Phaser.Loader.html" target="_blank" rel="noopener">官网文档Phaser. Loader</a>。</p>
<h5 id="（1）预加载"><a href="#（1）预加载" class="headerlink" title="（1）预加载"></a>（1）预加载</h5><p><strong>普通图片</strong></p>
<figure class="highlight sqf"><table><tr><td class="code"><pre><span class="line">customGame.<span class="built_in">load</span>.<span class="built_in">image</span>(<span class="string">'popup'</span> , <span class="string">'../img/sprite.popup.png'</span>);</span><br></pre></td></tr></table></figure>
<p>普通图片使用的是<code>game.load.image(图片key名，图片地址)</code>;</p>
<p><strong>雪碧图</strong></p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">customGame.load.atlasJSONHash(<span class="string">'tvshow'</span> , <span class="string">'../img/tvshow.png'</span> , <span class="string">''</span> , <span class="keyword">this</span>.tvshowJson);</span><br></pre></td></tr></table></figure>
<p>雪碧图的合成工具我使用的是<a href="https://www.codeandweb.com/texturepacker" target="_blank" rel="noopener">texturepacker</a>，选择的是输出文件模式是Phaser(JSONHash)，因此使用的是atlasJSONHash方法。第一个参数为图片key名，第二个参数为资源地址，第三个参数为图片数据文件地址，第四个参数为图片数据json或xml对象。</p>
<h5 id="（2）图片跨域"><a href="#（2）图片跨域" class="headerlink" title="（2）图片跨域"></a>（2）图片跨域</h5><p>如果图片资源和画布不是同源的，需要设置图片可跨域。</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">customGame.<span class="built_in">load</span>.crossOrigin = <span class="string">'anonymous'</span>;</span><br></pre></td></tr></table></figure>
<h5 id="（3）监听加载事件"><a href="#（3）监听加载事件" class="headerlink" title="（3）监听加载事件"></a>（3）监听加载事件</h5><p><strong>单个资源加载完成事件</strong></p>
<p>通过<code>onFileComplete</code>方法来监听每个资源加载完的事件，可以用来获取加载进度。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">customGame.load.onFileComplete.add(<span class="keyword">this</span>.loadProgress , <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadProgress</span>(<span class="params">progress</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//progress为获取的资源进度百分比</span></span><br><span class="line">    $(<span class="string">'.J_loading .progress'</span>).text(<span class="string">`<span class="subst">$&#123;progress&#125;</span>%`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>onFileComplete</code>第一个参数为每个资源加载完的事件，第二个参数为指定该事件的上下文。</p>
<p><strong>全部资源加载完成事件</strong></p>
<p>通过<code>onLoadComplete</code>方法来监听全部资源加载完成事件。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">customGame</span><span class="selector-class">.load</span><span class="selector-class">.onLoadComplete</span><span class="selector-class">.addOnce</span>(<span class="selector-tag">this</span><span class="selector-class">.loadComplete</span> , <span class="selector-tag">this</span>);</span><br></pre></td></tr></table></figure>
<p>第一个参数为加载完成事件，第二个参数为指定该事件的上下文。</p>
<p>以上就是预加载的主要实现。</p>
<p><br></p>
<h1 id="四、游戏逻辑"><a href="#四、游戏逻辑" class="headerlink" title="四、游戏逻辑"></a>四、游戏逻辑</h1><p>游戏逻辑大致可以分为四个部分，分别为画面初始化、物件选择面板的创建、元素的编辑、生成长图。</p>
<h4 id="1-画面初始化-1"><a href="#1-画面初始化-1" class="headerlink" title="1.画面初始化"></a>1.画面初始化</h4><p>初始化的页面主要有墙面、桌子和电视机，主要是创建这三个物件。在此之前，先介绍下用到的两个概念。</p>
<p><strong>sprite</strong> ：可用于展示绝大部分的可视化的对象。<br><figure class="highlight cs"><table><tr><td class="code"><pre><span class="line"><span class="comment">//创建新图像</span></span><br><span class="line"><span class="comment">//spriteName为预加载资源的唯一key，frame为雪碧图内的frame名，可通过雪碧图的json获得</span></span><br><span class="line"><span class="keyword">const</span> newObject = game.<span class="keyword">add</span>.sprite(<span class="number">0</span>,<span class="number">0</span>,spriteName , frame);</span><br></pre></td></tr></table></figure></p>
<p><strong>group</strong> ：用于包含一系列对象的容器，方便批量操作对象，比如移动、旋转、放大等。<br><figure class="highlight cs"><table><tr><td class="code"><pre><span class="line"><span class="comment">//创建组</span></span><br><span class="line"><span class="keyword">const</span> group1 = game.<span class="keyword">add</span>.<span class="keyword">group</span>();</span><br><span class="line"><span class="comment">//向组内添加新对象newObject</span></span><br><span class="line">group1.<span class="keyword">add</span>(newObject);</span><br></pre></td></tr></table></figure></p>
<p>接下来是实例，创建墙面、桌子和电视机：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">//play.js</span></span><br><span class="line"><span class="keyword">const</span> play = &#123;</span><br><span class="line">    create : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.createEditPage();  <span class="comment">//创建编辑页</span></span><br><span class="line">    &#125;,</span><br><span class="line">    createEditPage : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mobilityGroup = customGame.add.group();    <span class="comment">//创建mobilityGroup组，用于存放游戏中的物件</span></span><br><span class="line">        <span class="keyword">this</span>.createWall();      <span class="comment">//创建墙</span></span><br><span class="line">        <span class="keyword">this</span>.createTableSofa(<span class="string">'sofatable1.png'</span>);     <span class="comment">//创建沙发</span></span><br><span class="line">        <span class="keyword">this</span>.createTelevision(<span class="string">'television1.png'</span>);   <span class="comment">//创建电视机</span></span><br><span class="line">    &#125;,</span><br><span class="line">    createWall : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> wall = customGame.add.sprite(<span class="number">0</span>,<span class="keyword">this</span>.gameHeightHf + <span class="number">80</span>,<span class="string">'wall1.png'</span>);</span><br><span class="line"></span><br><span class="line">        wall.anchor.set(<span class="number">0</span> , <span class="number">0.5</span>);  </span><br><span class="line">        wall.name = <span class="string">'wall'</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.mobilityGroup.add(wall);</span><br><span class="line">    &#125;,</span><br><span class="line">    createTableSofa : <span class="function"><span class="keyword">function</span>(<span class="params">spriteName</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> tableSofa = customGame.add.sprite(<span class="keyword">this</span>.gameWidthHf , <span class="keyword">this</span>.gameHeightHf + <span class="number">20</span>, <span class="string">'tableSofa'</span> , spriteName );</span><br><span class="line"></span><br><span class="line">        tableSofa.anchor.set(<span class="number">0.5</span>,<span class="number">0.5</span>);</span><br><span class="line">        tableSofa.name = <span class="string">'tableSofa'</span>;</span><br><span class="line">        tableSofa.keyNum = <span class="keyword">this</span>.keyNum++;   <span class="comment">//设置唯一key值</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.mobilityGroup.add(tableSofa);</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = play;</span><br></pre></td></tr></table></figure>
<p><code>createTelevision</code>创建同<code>createTableSofa</code>，可通过源码查看。<br><code>object.anchor.set(0,0)</code> 设置对象偏移位置的基准点，默认是左上角的位置（0,0），如果是右下角则是（1,1），对象的中间点是（0.5,0.5）；<br><code>object.name = &#39;name&#39;</code>设置对象的名称，可通过<code>group.getByName(name)</code>从组中获取该对象。</p>
<p>这样就会在页面上创建一个这样的画面：</p>
<p><img src="/2019/01/24/如何用Phaser实现一个全家福拼图h5/04.png" alt=""></p>
<p><br></p>
<h4 id="2-物件选择面板的创建"><a href="#2-物件选择面板的创建" class="headerlink" title="2.物件选择面板的创建"></a>2.物件选择面板的创建</h4><p>物件选择面板的主要逻辑可以分为几部分：创建左侧tab和批量创建元素、tab切换、元素滑动和新增元素。</p>
<h5 id="（1）创建左侧tab和批量创建元素"><a href="#（1）创建左侧tab和批量创建元素" class="headerlink" title="（1）创建左侧tab和批量创建元素"></a>（1）创建左侧tab和批量创建元素</h5><p>物件选择面板可以分为新年快乐框、tab标题、tab内容、完成按钮四个部分。</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">createEditPage : function()&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">this</span>.createEditWrap();          <span class="comment">//创建编辑面板</span></span><br><span class="line">&#125;,</span><br><span class="line">createEditWrap : function()&#123;</span><br><span class="line">    <span class="keyword">this</span>.editGroup = customGame.add.group();    <span class="comment">//editGroup用于存放面板的所有元素</span></span><br><span class="line">    <span class="keyword">this</span>.createNewyear();           <span class="comment">//创建新年快乐框</span></span><br><span class="line">    <span class="keyword">this</span>.createEditContent();       <span class="comment">//创建tab内容</span></span><br><span class="line">    <span class="keyword">this</span>.createEditTab();           <span class="comment">//创建tab标题</span></span><br><span class="line">    <span class="keyword">this</span>.createFinishBtn();         <span class="comment">//创建完成按钮</span></span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>新年快乐框、tab标题、完成按钮的实现可以查看源码，这里主要着重介绍tab内容的实现。</p>
<p>物件选择面板主要有四个tab类：</p>
<p><img src="/2019/01/24/如何用Phaser实现一个全家福拼图h5/05.jpg" alt=""></p>
<p>四个tab类创建方式相同，因此取较为复杂的人物tab类为例介绍实现方法。</p>
<p>这里插播一些新的API：</p>
<p><strong>graphics：</strong> 可以用来绘画，比如矩形、圆形、多边形等图形，还可以用来绘画直线、圆弧、曲线等各种基本物体。</p>
<figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line"><span class="comment">//新建图形，第一个参数为x轴位置，第二个参数为y轴位置</span></span><br><span class="line">const graphicObject = game.add.graphics(<span class="number">0</span>,<span class="number">100</span>); </span><br><span class="line"><span class="comment">//画一个黑色的矩形</span></span><br><span class="line">graphicObject.beginFill(<span class="number">0x000000</span>);  <span class="comment">//设置矩形的颜色</span></span><br><span class="line">graphicObject.drawRect(<span class="number">0</span>,<span class="number">0</span>,<span class="number">100</span> , <span class="number">100</span>);   <span class="comment">//设置矩形的x,y,width,height</span></span><br></pre></td></tr></table></figure>
<p>编辑框的实现：<br><figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">//index.js</span></span><br><span class="line">createEditContent : function()&#123;</span><br><span class="line">    const maskHeight = <span class="keyword">this</span>.isIPhoneXX ? (<span class="keyword">this</span>.gameHeight - <span class="number">467</span>) : (<span class="keyword">this</span>.gameHeight - <span class="number">430</span>);</span><br><span class="line">    const editContent = customGame.add.graphics(<span class="number">0</span> , <span class="keyword">this</span>.gameHeight); </span><br><span class="line">    <span class="comment">//遮罩</span></span><br><span class="line">    const mask = customGame.add.graphics(<span class="number">0</span>, maskHeight);    </span><br><span class="line">    mask.beginFill(<span class="number">0x000000</span>);</span><br><span class="line">    mask.drawRect(<span class="number">0</span>,<span class="number">0</span>,<span class="keyword">this</span>.gameWidth , <span class="number">467</span>); </span><br><span class="line">    <span class="comment">//tab内容背景</span></span><br><span class="line">    editContent.beginFill(<span class="number">0xffffff</span>);</span><br><span class="line">    editContent.drawRect(<span class="number">0</span>,<span class="number">0</span>,<span class="keyword">this</span>.gameWidth , <span class="number">350</span>);</span><br><span class="line">    editContent.mask = mask;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.editGroup.add(editContent);</span><br><span class="line">    <span class="keyword">this</span>.editContent = editContent;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建人物</span></span><br><span class="line">    <span class="keyword">this</span>.createPostContent();</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>给<code>editContent</code>添加了遮罩是为了在子元素滑动的时候，可以遮住滑出的内容。</p>
<p>人物选择内容框分为左侧tab和右侧内容。左侧tab主要是文字，通过Phaser的text api实现，右侧通过封装的createEditListDetail方法批量生成。<br><figure class="highlight cs"><table><tr><td class="code"><pre><span class="line">createPostContent : function()&#123;</span><br><span class="line">    <span class="keyword">const</span> postContent = customGame.<span class="keyword">add</span>.<span class="keyword">group</span>(<span class="keyword">this</span>.editContent);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//左侧背景</span></span><br><span class="line">    <span class="keyword">const</span> leftTab = customGame.<span class="keyword">add</span>.graphics(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">const</span> leftTabGroup = customGame.<span class="keyword">add</span>.<span class="keyword">group</span>(leftTab)</span><br><span class="line">    leftTab.beginFill(<span class="number">0xfff7e0</span>);</span><br><span class="line">    leftTab.drawRect(<span class="number">0</span>,<span class="number">0</span>,<span class="number">155</span> , <span class="number">350</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//左侧选中背景</span></span><br><span class="line">    <span class="keyword">const</span> selected = customGame.<span class="keyword">add</span>.graphics(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    selected.beginFill(<span class="number">0xffffff</span>);</span><br><span class="line">    selected.drawRect(<span class="number">0</span>,<span class="number">0</span>,<span class="number">155</span>,<span class="number">70</span>);</span><br><span class="line">    selected.name = <span class="string">'selected'</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//左侧文字</span></span><br><span class="line">    <span class="keyword">const</span> text = customGame.<span class="keyword">add</span>.text(<span class="number">155</span>/<span class="number">2</span> , <span class="number">23</span> , <span class="string">"站姿\n坐姿\n瘫姿\n不可描述"</span> , &#123;font : <span class="string">"24px"</span> , fill : <span class="string">"#a55344"</span> , align : <span class="string">"center"</span>&#125;);</span><br><span class="line">    text.lineSpacing = <span class="number">35</span>;</span><br><span class="line">    text.anchor.<span class="keyword">set</span>(<span class="number">0.5</span> , <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//左侧文字区域</span></span><br><span class="line">    <span class="keyword">this</span>.createLeftBarSpan(<span class="number">4</span> ,leftTabGroup );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//右侧sprite合集</span></span><br><span class="line">    <span class="keyword">const</span> standSpriteSheet = &#123;</span><br><span class="line">        number : <span class="number">12</span>,</span><br><span class="line">        info : [</span><br><span class="line">            &#123; name : <span class="string">'stand'</span> , spriteSheetName : <span class="string">'stand'</span> , number : <span class="number">8</span> , startNum : <span class="number">0</span>&#125; , </span><br><span class="line">            &#123; name : <span class="string">'stand2'</span> , spriteSheetName : <span class="string">'stand'</span> , number : <span class="number">4</span> , startNum : <span class="number">8</span>&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> sitSpriteSheet = &#123; name : <span class="string">'sit'</span>, spriteSheetName : <span class="string">'sit'</span> , number : <span class="number">12</span>&#125;;</span><br><span class="line">    <span class="keyword">const</span> stallSpriteSheet = &#123; name : <span class="string">'stall'</span> , spriteSheetName : <span class="string">'stall'</span> , number : <span class="number">13</span>&#125;;</span><br><span class="line">    <span class="keyword">const</span> indescribeSpriteSheet = &#123; name : <span class="string">'indescribe'</span> , spriteSheetName : <span class="string">'indescribe'</span> , number : <span class="number">12</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 右侧合集</span></span><br><span class="line">    <span class="keyword">const</span> standGroup = customGame.<span class="keyword">add</span>.<span class="keyword">group</span>();</span><br><span class="line">    <span class="keyword">const</span> sitGroup = customGame.<span class="keyword">add</span>.<span class="keyword">group</span>();</span><br><span class="line">    <span class="keyword">const</span> stallGroup = customGame.<span class="keyword">add</span>.<span class="keyword">group</span>();</span><br><span class="line">    <span class="keyword">const</span> indescribeGroup = customGame.<span class="keyword">add</span>.<span class="keyword">group</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//右侧生成</span></span><br><span class="line">    <span class="keyword">const</span> stallSpecialSize = &#123;</span><br><span class="line">        <span class="string">'stall0.png'</span> : <span class="number">0.35</span>,</span><br><span class="line">        <span class="string">'stall9.png'</span> : <span class="number">0.35</span>,</span><br><span class="line">        <span class="string">'stall12.png'</span> : <span class="number">0.8</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">const</span> standSpecialSize = &#123;</span><br><span class="line">        <span class="string">'stand8.png'</span> : <span class="number">0.6</span>,</span><br><span class="line">        <span class="string">'stand9.png'</span> : <span class="number">0.6</span>,</span><br><span class="line">        <span class="string">'stand10.png'</span> : <span class="number">0.6</span>,</span><br><span class="line">        <span class="string">'stand11.png'</span> : <span class="number">0.6</span>,</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">this</span>.createEditListDetail(standSpriteSheet , <span class="number">0.37</span> , standGroup , <span class="number">105</span> , <span class="number">220</span> , <span class="number">25</span> , <span class="number">20</span> , <span class="number">40</span> , <span class="number">17</span> , <span class="number">160</span> , <span class="number">590</span> , standSpecialSize , <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">this</span>.createEditListDetail(sitSpriteSheet , <span class="number">0.42</span> , sitGroup , <span class="number">105</span> , <span class="number">220</span>, <span class="number">25</span> , <span class="number">20</span>, <span class="number">40</span> , <span class="number">17</span>, <span class="number">160</span> , <span class="number">590</span> , <span class="literal">null</span> , <span class="number">4</span>);</span><br><span class="line">    <span class="keyword">this</span>.createEditListDetail(stallSpriteSheet , <span class="number">0.4</span> , stallGroup , <span class="number">170</span> , <span class="number">194</span>, <span class="number">25</span> , <span class="number">15</span>, <span class="number">33</span> , <span class="number">30</span>, <span class="number">160</span>, <span class="number">590</span> , stallSpecialSize , <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">this</span>.createEditListDetail(indescribeSpriteSheet , <span class="number">0.4</span> , indescribeGroup , <span class="number">105</span> , <span class="number">220</span>, <span class="number">25</span> , <span class="number">20</span>, <span class="number">40</span> , <span class="number">17</span>, <span class="number">160</span> , <span class="number">590</span> , <span class="literal">null</span> , <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    leftTabGroup.addMultiple([selected,text]);</span><br><span class="line">    postContent.addMultiple([leftTab,sitGroup,standGroup,stallGroup,indescribeGroup])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.postContent = postContent;</span><br><span class="line">    <span class="keyword">this</span>.postLeftTab = leftTabGroup;</span><br><span class="line">    <span class="keyword">this</span>.sitGroup = sitGroup;</span><br><span class="line">    <span class="keyword">this</span>.standGroup = standGroup;</span><br><span class="line">    <span class="keyword">this</span>.stallGroup = stallGroup;</span><br><span class="line">    <span class="keyword">this</span>.indescribeGroup = indescribeGroup;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p>
<p>右侧的内容需要考虑的是不同内容的位置、尺寸和显示数量不一定的问题，因此需要抽取出不同的设置作为参数传入：</p>
<figure class="highlight typescript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * </span></span><br><span class="line"><span class="comment">    * @param &#123;*&#125; spriteSheet  spriteSheet雪碧图信息</span></span><br><span class="line"><span class="comment">    * @param &#123;*&#125; scaleRate    图像显示的缩放</span></span><br><span class="line"><span class="comment">    * @param &#123;*&#125; group        新建图像存放的组</span></span><br><span class="line"><span class="comment">    * @param &#123;*&#125; spriteWidth  图像显示区域尺寸的宽度</span></span><br><span class="line"><span class="comment">    * @param &#123;*&#125; spriteHeight 图像显示区域尺寸的高度</span></span><br><span class="line"><span class="comment">    * @param &#123;*&#125; verticalW     图像显示区域的横向间距</span></span><br><span class="line"><span class="comment">    * @param &#123;*&#125; horizentalH   图像显示区域的纵向间距</span></span><br><span class="line"><span class="comment">    * @param &#123;*&#125; startX        整块图像区域的x偏移量</span></span><br><span class="line"><span class="comment">    * @param &#123;*&#125; startY        整块图像区域的y偏移量</span></span><br><span class="line"><span class="comment">    * @param &#123;*&#125; groupleft     左侧tab的宽度</span></span><br><span class="line"><span class="comment">    * @param &#123;*&#125; groupWidth    整块区域的宽度</span></span><br><span class="line"><span class="comment">    * @param &#123;*&#125; specialSize   特殊元素的缩放尺寸，由于元素的尺寸缩放标准不一，因此需要设置特殊元素的缩放尺寸</span></span><br><span class="line"><span class="comment">    * @param &#123;*&#125; verticalNum   列项数量</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">createEditListDetail : <span class="function"><span class="keyword">function</span>(<span class="params">spriteSheet , scaleRate , group , spriteWidth , spriteHeight , verticalW , horizentalH , startX , startY , groupleft ,groupWidth , specialSize , verticalNum</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> &#123; name , spriteSheetName , <span class="built_in">number</span> &#125; = spriteSheet; </span><br><span class="line">    <span class="keyword">const</span> hv = <span class="built_in">number</span> % verticalNum == <span class="number">0</span> ? <span class="built_in">number</span> : <span class="built_in">number</span> + (verticalNum-<span class="built_in">number</span>%verticalNum);</span><br><span class="line">    <span class="keyword">const</span> box = customGame.add.graphics(groupleft,<span class="number">0</span>,group);</span><br><span class="line">    box.beginFill(<span class="number">0xffffff</span>);</span><br><span class="line">    box.drawRect(<span class="number">0</span>,<span class="number">0</span>,groupWidth,startY + (spriteHeight + horizentalH) * <span class="built_in">parseInt</span>(hv/verticalNum) + horizentalH);        </span><br><span class="line">    box.name = <span class="string">'box'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//由于元素的体积过大，部分元素集不能都合并成一张雪碧图，因此需要区分合并成一张和多张都情况</span></span><br><span class="line">    <span class="keyword">if</span>(spriteSheet.info)&#123;</span><br><span class="line">        <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">        spriteSheet.info.map(<span class="function">(<span class="params">item , index</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> &#123; name , spriteSheetName , <span class="built_in">number</span>&#125; = item;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> j = <span class="number">0</span> ; j &lt; <span class="built_in">number</span> ; j++)&#123;</span><br><span class="line">                createOne(i, name , spriteSheetName);</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span> ;  i &lt; <span class="built_in">number</span> ; i++ )&#123;</span><br><span class="line">            createOne(i, name , spriteSheetName)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">createOne</span>(<span class="params">i , name , spriteSheetName</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">const</span> x = startX + (spriteWidth+verticalW) * (i%verticalNum) + spriteWidth/<span class="number">2</span>,</span><br><span class="line">                y = startY + (spriteHeight + horizentalH) * <span class="built_in">parseInt</span>(i/verticalNum) + spriteHeight/<span class="number">2</span>;  </span><br><span class="line">        <span class="keyword">const</span> item = customGame.add.sprite(x , y , name , <span class="string">`<span class="subst">$&#123;spriteSheetName&#125;</span><span class="subst">$&#123;i&#125;</span>.png`</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> realScaleRate = scaleRate;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(spriteWidth/item.width &gt;= <span class="number">1.19</span>)&#123;</span><br><span class="line">            realScaleRate = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(specialSize &amp;&amp; specialSize[<span class="string">`<span class="subst">$&#123;spriteSheetName&#125;</span><span class="subst">$&#123;i&#125;</span>.png`</span>])&#123;</span><br><span class="line">            realScaleRate = specialSize[<span class="string">`<span class="subst">$&#123;spriteSheetName&#125;</span><span class="subst">$&#123;i&#125;</span>.png`</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        item.anchor.set(<span class="number">0.5</span>);</span><br><span class="line">        item.scale.set(realScaleRate);</span><br><span class="line">        item.inputEnabled = <span class="literal">true</span>;</span><br><span class="line">        box.addChild(item);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>到这里就搭好了游戏的全部画面，接下来是tab的切换。<br><br></p>
<h5 id="（2）tab切换"><a href="#（2）tab切换" class="headerlink" title="（2）tab切换"></a>（2）tab切换</h5><p>tab的切换逻辑是显示指定的内容，隐藏其他内容。通过组的<code>visible</code>属性设置元素的显示和隐藏。</p>
<figure class="highlight haxe"><table><tr><td class="code"><pre><span class="line"><span class="comment">//显示</span></span><br><span class="line"><span class="keyword">new</span><span class="type">Object</span>.visible = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">//隐藏</span></span><br><span class="line"><span class="keyword">new</span><span class="type">Object</span>.visible = <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>除此之外，tab的切换还涉及到元素的点击事件，绑定事件前需要激活元素的<code>inputEnabled</code>属性，在元素的<code>events</code>属性上添加点击事件：</p>
<figure class="highlight haxe"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span><span class="type">Object</span>.inputEnabled = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">new</span><span class="type">Object</span>.events.onInputDown.add(clickHandler , <span class="built_in">this</span>);  <span class="comment">//第一个参数为事件的回调函数，第二个参数为绑定的上下文</span></span><br></pre></td></tr></table></figure>
<p>以人物选择内容框的左侧tab切换为例</p>
<p>给左侧tab添加点击事件：</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">createPostContent : function()&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//组内批量添加点击事件，用setAll设置属性，用callAll添加事件</span></span><br><span class="line">    leftTabGroup.setAll(<span class="string">'inputEnabled'</span> , <span class="literal">true</span>);</span><br><span class="line">    leftTabGroup.callAll(<span class="string">'events.onInputDown.add'</span> , <span class="string">'events.onInputDown'</span> , <span class="keyword">this</span>.switchPost , <span class="keyword">this</span>);</span><br><span class="line">&#125;,</span><br><span class="line">switchPost : function(e)&#123;</span><br><span class="line">    const item = e.name || <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">if</span>(!item) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    let selectedTop = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    switch(item)&#123;</span><br><span class="line">        case <span class="string">'text0'</span> :</span><br><span class="line">            selectedTop = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">this</span>.standGroup.visible = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">this</span>.sitGroup.visible = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">this</span>.stallGroup.visible = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">this</span>.indescribeGroup.visible = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        case <span class="string">'text1'</span> :</span><br><span class="line">            selectedTop = <span class="number">70</span>;</span><br><span class="line">            <span class="keyword">this</span>.standGroup.visible = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">this</span>.sitGroup.visible = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">this</span>.stallGroup.visible = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">this</span>.indescribeGroup.visible = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        case <span class="string">'text2'</span> :</span><br><span class="line">            selectedTop = <span class="number">140</span>;</span><br><span class="line">            <span class="keyword">this</span>.standGroup.visible = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">this</span>.sitGroup.visible = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">this</span>.stallGroup.visible = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">this</span>.indescribeGroup.visible = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        case <span class="string">'text3'</span> :</span><br><span class="line">            selectedTop = <span class="number">210</span>;</span><br><span class="line">            <span class="keyword">this</span>.standGroup.visible = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">this</span>.sitGroup.visible = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">this</span>.stallGroup.visible = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">this</span>.indescribeGroup.visible = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//设置选中框的位置</span></span><br><span class="line">    <span class="keyword">this</span>.postLeftTab.getByName(<span class="string">'selected'</span>).y = selectedTop;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p><br></p>
<h5 id="（3）元素滑动和新增元素"><a href="#（3）元素滑动和新增元素" class="headerlink" title="（3）元素滑动和新增元素"></a>（3）元素滑动和新增元素</h5><p>这里把元素滑动和新增元素放在一起是考虑到组内元素的滑动操作和点击操作的冲突，元素的滑动是通过拖拽实现，如果组内元素添加了点击事件，点击事件优先于父元素的拖拽事件，当手指触摸到子元素时，无法触发拖拽事件。如果忽略子元素的点击事件，则无法捕获子元素的点击事件。</p>
<p>因此给元素添加滑动的逻辑如下：</p>
<p>1.触发滑动的父元素的拖拽功能，并且禁止横向拖拽，允许纵享拖拽。<br>2.给元素添加物理引擎（因为要给元素一个惯性的速度）。<br>3.结合onDragStart、onDragStop和onInputUp三个事件的触发判断用户的操作是点击还是滑动，如果是滑动，则三个事件都会触发，并且onInputUp的事件优先于onDragStop，如果是点击，则只会触发InputUp。<br>4.在onDragUpdate设置边界点，如果用户滑动超过一定边界点则只能滑动到边界点。<br>5.在onDragStop判断用户滑动的距离和时间计算出手势停止时，给定元素的速度。<br>6.在onDragStart判断是否有因惯性正在移动的元素，如果有则让该元素停止运动，让移动速度为0。<br>6.在update里让移动元素的速度减少直至为0停下来模拟惯性。</p>
<figure class="highlight processing"><table><tr><td class="code"><pre><span class="line">addScrollHandler : function(target)&#123;</span><br><span class="line">    let isDrag = <span class="keyword">false</span>; <span class="comment">//判断是否滑动的标识</span></span><br><span class="line">    let startY , endY , startTime , endTime;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">box</span> = target.getByName(<span class="string">'box'</span>);</span><br><span class="line">    <span class="built_in">box</span>.inputEnabled = <span class="keyword">true</span>;</span><br><span class="line">    <span class="built_in">box</span>.input.enableDrag();</span><br><span class="line">    <span class="built_in">box</span>.input.allowHorizontalDrag = <span class="keyword">false</span>;  <span class="comment">//禁止横向拖拽</span></span><br><span class="line">    <span class="built_in">box</span>.input.allowVerticalDrag = <span class="keyword">true</span>;     <span class="comment">//允许纵向拖拽</span></span><br><span class="line">    <span class="built_in">box</span>.ignoreChildInput = <span class="keyword">true</span>;            <span class="comment">//忽略子元素事件</span></span><br><span class="line">    <span class="built_in">box</span>.input.dragDistanceThreshold = <span class="number">10</span>;       <span class="comment">//滑动阈值</span></span><br><span class="line">    <span class="comment">//允许滑动到底部的最高值</span></span><br><span class="line">    <span class="keyword">const</span> maxBoxY = -(<span class="built_in">box</span>.<span class="built_in">height</span> - <span class="number">350</span>);       </span><br><span class="line">    <span class="comment">//给父元素添加物理引擎</span></span><br><span class="line">    customGame.physics.arcade.enable(<span class="built_in">box</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">box</span>.events.onDragUpdate.<span class="built_in">add</span>(function()&#123;</span><br><span class="line">        <span class="comment">//滑到顶部，禁止继续往下滑</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">box</span>.y &gt; <span class="number">100</span>)&#123;</span><br><span class="line">            <span class="built_in">box</span>.y = <span class="number">100</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">box</span>.y &lt; maxBoxY - <span class="number">100</span>)&#123;</span><br><span class="line">            <span class="comment">//滑到底部，禁止继续往上滑</span></span><br><span class="line">            <span class="built_in">box</span>.y = maxBoxY - <span class="number">100</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        endY = arguments[<span class="number">3</span>];</span><br><span class="line">        endTime = +<span class="keyword">new</span> Date();</span><br><span class="line">    &#125; , <span class="keyword">this</span>);</span><br><span class="line">    <span class="built_in">box</span>.events.onDragStart.<span class="built_in">add</span>(function()&#123;</span><br><span class="line">        isDrag = <span class="keyword">true</span>;</span><br><span class="line">        startY = arguments[<span class="number">3</span>];</span><br><span class="line">        startTime = +<span class="keyword">new</span> Date();</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">this</span>.currentScrollBox)&#123;</span><br><span class="line">            <span class="comment">//如果当前有其他正在滑动的元素，取消滑动</span></span><br><span class="line">            <span class="keyword">this</span>.currentScrollBox.body.velocity.y = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">this</span>.currentScrollBox = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; , <span class="keyword">this</span>);</span><br><span class="line">    <span class="built_in">box</span>.events.onDragStop.<span class="built_in">add</span>(function()&#123;</span><br><span class="line">        isDrag = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">//指定可以点击滑动的区域</span></span><br><span class="line">        <span class="built_in">box</span>.hitArea = <span class="keyword">new</span> Phaser.Rectangle(<span class="number">0</span>,-<span class="built_in">box</span>.y,<span class="built_in">box</span>.<span class="built_in">width</span>,<span class="built_in">box</span>.<span class="built_in">height</span> + <span class="built_in">box</span>.y);</span><br><span class="line">        <span class="comment">//向下滑动到极限，给极限到最值位置动画</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">box</span>.y &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">box</span>.hitArea = <span class="keyword">new</span> Phaser.Rectangle(<span class="number">0</span>, <span class="number">0</span> , <span class="built_in">box</span>.<span class="built_in">width</span> , <span class="built_in">box</span>.<span class="built_in">height</span>);</span><br><span class="line">            customGame.<span class="built_in">add</span>.tween(<span class="built_in">box</span>).to(&#123; y : <span class="number">0</span>&#125; , <span class="number">100</span> , Phaser.Easing.Linear.None, <span class="keyword">true</span> , <span class="number">0</span> , <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//向上滑动到极限，给极限到最值位置动画</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">box</span>.y &lt; maxBoxY)&#123;</span><br><span class="line">            <span class="built_in">box</span>.hitArea = <span class="keyword">new</span> Phaser.Rectangle(<span class="number">0</span>, -maxBoxY , <span class="built_in">box</span>.<span class="built_in">width</span> , <span class="built_in">box</span>.<span class="built_in">height</span> - maxBoxY);</span><br><span class="line">            customGame.<span class="built_in">add</span>.tween(<span class="built_in">box</span>).to(&#123; y : maxBoxY&#125; , <span class="number">100</span> , Phaser.Easing.Linear.None , <span class="keyword">true</span> , <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//模拟滑动停止父元素仍滑动到停止的惯性</span></span><br><span class="line">        <span class="comment">//根据用户的滑动距离和滑动事件计算元素的惯性滑动速度</span></span><br><span class="line">        <span class="keyword">const</span> velocity = (Math.<span class="built_in">abs</span>(Math.<span class="built_in">abs</span>(endY) - Math.<span class="built_in">abs</span>(startY)) / (endTime - startTime)) * <span class="number">40</span>;</span><br><span class="line">        <span class="comment">//scrollFlag标识父元素是向上滑动还是向下滑动</span></span><br><span class="line">        <span class="keyword">if</span>(endY &gt; startY)&#123;<span class="comment">// 向下</span></span><br><span class="line">            <span class="built_in">box</span>.body.velocity.y = velocity;</span><br><span class="line">            <span class="built_in">box</span>.scrollFlag = <span class="string">'down'</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(endY &lt; startY)&#123; <span class="comment">//向上</span></span><br><span class="line">            <span class="built_in">box</span>.body.velocity.y = -velocity;</span><br><span class="line">            <span class="built_in">box</span>.scrollFlag = <span class="string">'up'</span>;</span><br><span class="line">        &#125;   </span><br><span class="line">        <span class="keyword">this</span>.currentScrollBox = <span class="built_in">box</span>;         </span><br><span class="line">    &#125; , <span class="keyword">this</span>);</span><br><span class="line">    <span class="built_in">box</span>.events.onInputUp.<span class="built_in">add</span>(function(e , p )&#123;</span><br><span class="line">        <span class="keyword">if</span>(isDrag) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> curX = p.position.x - e.previousPosition.x;</span><br><span class="line">        <span class="keyword">const</span> curY = p.position.y - e.previousPosition.y;</span><br><span class="line">        <span class="comment">//根据点击区域，判断用户点击的是哪个元素</span></span><br><span class="line">        <span class="keyword">const</span> idx = e.wrapData.findIndex((val , index , arr) =&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> curX &gt;= val.minX &amp;&amp; curX &lt;= val.maxX &amp;&amp; curY &gt;= val.minY &amp;&amp; curY &lt;= val.maxY;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">if</span>(idx == <span class="number">-1</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">const</span> children = e.children[idx];</span><br><span class="line">        <span class="comment">//添加新元素到画面</span></span><br><span class="line">        <span class="keyword">this</span>.addNewMobilityObject(children.<span class="built_in">key</span> , children._frame.name);</span><br><span class="line">    &#125; , <span class="keyword">this</span>);</span><br><span class="line">&#125;,</span><br><span class="line">dealScrollObject : function()&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.currentScrollBox &amp;&amp; <span class="keyword">this</span>.currentScrollBox.body.velocity.y !== <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> currentScrollBox = <span class="keyword">this</span>.currentScrollBox,</span><br><span class="line">                <span class="built_in">height</span> = currentScrollBox.<span class="built_in">height</span>,</span><br><span class="line">                <span class="built_in">width</span> = currentScrollBox.<span class="built_in">width</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> maxBoxY = -(<span class="built_in">height</span> - <span class="number">350</span>);</span><br><span class="line">        <span class="keyword">if</span>(currentScrollBox.y &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            currentScrollBox.hitArea = <span class="keyword">new</span> Phaser.Rectangle(<span class="number">0</span>, <span class="number">0</span> , <span class="built_in">width</span> , <span class="built_in">height</span>);</span><br><span class="line">            customGame.<span class="built_in">add</span>.tween(currentScrollBox).to(&#123; y : <span class="number">0</span>&#125; , <span class="number">100</span> , Phaser.Easing.Linear.None, <span class="keyword">true</span> , <span class="number">0</span> , <span class="number">0</span>);</span><br><span class="line">            currentScrollBox.body.velocity.y = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(currentScrollBox.y &lt; maxBoxY)&#123;</span><br><span class="line">            currentScrollBox.hitArea = <span class="keyword">new</span> Phaser.Rectangle(<span class="number">0</span>, -maxBoxY , <span class="built_in">width</span> , <span class="built_in">height</span> - maxBoxY);</span><br><span class="line">            customGame.<span class="built_in">add</span>.tween(currentScrollBox).to(&#123; y : maxBoxY&#125; , <span class="number">100</span> , Phaser.Easing.Linear.None , <span class="keyword">true</span> , <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            currentScrollBox.body.velocity.y = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        currentScrollBox.hitArea = <span class="keyword">new</span> Phaser.Rectangle(<span class="number">0</span>,-currentScrollBox.y,<span class="built_in">width</span>,<span class="built_in">height</span> + currentScrollBox.y);</span><br><span class="line">        <span class="keyword">if</span>(currentScrollBox.scrollFlag == <span class="string">'up'</span>)&#123;</span><br><span class="line">            currentScrollBox.body.velocity.y += <span class="number">1.5</span>;</span><br><span class="line">            <span class="keyword">if</span>(currentScrollBox.body.velocity.y &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">                currentScrollBox.body.velocity.y = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(currentScrollBox.scrollFlag == <span class="string">'down'</span>)&#123;</span><br><span class="line">            currentScrollBox.body.velocity.y -= <span class="number">1.5</span>;</span><br><span class="line">            <span class="keyword">if</span>(currentScrollBox.body.velocity.y &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">                currentScrollBox.body.velocity.y = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;,</span><br><span class="line">update : function()&#123;</span><br><span class="line">    <span class="keyword">this</span>.dealScrollObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>每次元素移动都要设置<code>hitArea</code>属性，用来设置元素的点击和滑动区域。这是因为元素的mask不可见区域还是可点击和滑动的，需要手动设置。</p>
<p><strong>新增元素：</strong></p>
<figure class="highlight pf"><table><tr><td class="code"><pre><span class="line">addNewMobilityObject : function(key , name)&#123;</span><br><span class="line">    //默认新元素的位置在屏幕居中位置取随机值</span><br><span class="line">    const <span class="keyword">random</span>P<span class="keyword">os</span> = <span class="number">30</span> * Math.<span class="keyword">random</span>();</span><br><span class="line">    const posX = Math.<span class="keyword">random</span>() &gt; <span class="number">0.5</span> ? this.gameWidthHf + <span class="keyword">random</span>P<span class="keyword">os</span> : this.gameWidthHf - <span class="keyword">random</span>P<span class="keyword">os</span>;</span><br><span class="line">    const posY = Math.<span class="keyword">random</span>() &gt; <span class="number">0.5</span> ? this.gameHeightHf + <span class="keyword">random</span>P<span class="keyword">os</span> : this.gameHeightHf - <span class="keyword">random</span>P<span class="keyword">os</span>;</span><br><span class="line">    const newOne = customGame.add.sprite(posX , posY , key , name);</span><br><span class="line"></span><br><span class="line">    newOne.<span class="built_in">anchor</span>.<span class="built_in">set</span>(<span class="number">0.5</span>);</span><br><span class="line">    newOne.keyNum = this.keyNum++;</span><br><span class="line"></span><br><span class="line">    this.mobilityGroup.add(newOne);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p><br></p>
<h4 id="3-元素编辑"><a href="#3-元素编辑" class="headerlink" title="3.元素编辑"></a>3.元素编辑</h4><p>新添加的元素或点击画面区内的元素，会有这样的编辑框出现，使得该元素可进行删除缩放操作。</p>
<p><img src="/2019/01/24/如何用Phaser实现一个全家福拼图h5/06.png" alt=""></p>
<p><strong>绘制编辑框</strong></p>
<figure class="highlight processing"><table><tr><td class="code"><pre><span class="line">addNewMobilityObject : function()&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">//绑定选中元素</span></span><br><span class="line">    <span class="keyword">this</span>.bindObjectSelected(newOne);</span><br><span class="line">    <span class="comment">//让新建元素成为当前选中元素</span></span><br><span class="line">    <span class="keyword">this</span>.objectSelected(newOne);</span><br><span class="line">&#125;,</span><br><span class="line">bindObjectSelected : function(target)&#123;</span><br><span class="line">    target.inputEnabled = <span class="keyword">true</span>;</span><br><span class="line">    target.input.enableDrag(<span class="keyword">false</span> , <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">//绘制编辑框</span></span><br><span class="line">    target.events.onDragStart.<span class="built_in">add</span>(<span class="keyword">this</span>.objectSelected , <span class="keyword">this</span> ); </span><br><span class="line">&#125;,</span><br><span class="line">objectSelected : function(e, p)&#123;</span><br><span class="line">    <span class="keyword">if</span>(e.name == <span class="string">'wall'</span> || e.name == <span class="keyword">this</span>.selectedObject) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">//如果点击的元素是当前选中元素，则不进行任何操作</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.selectWrap &amp;&amp; e.keyNum == <span class="keyword">this</span>.selectWrap.keyNum) <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">//去掉当前选中元素状态</span></span><br><span class="line">    <span class="keyword">this</span>.deleteCurrentWrap();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> offsetNum = <span class="number">10</span> , </span><br><span class="line">            <span class="built_in">width</span> = e.<span class="built_in">width</span>,</span><br><span class="line">            <span class="built_in">height</span> = e.<span class="built_in">height</span>, </span><br><span class="line">            offsetX = -<span class="built_in">width</span>/<span class="number">2</span> ,</span><br><span class="line">            offsetY = -<span class="built_in">height</span> / <span class="number">2</span>,</span><br><span class="line">            boxWidth = <span class="built_in">width</span> + <span class="number">2</span>*offsetNum , </span><br><span class="line">            boxHeight = <span class="built_in">height</span> + <span class="number">2</span>*offsetNum; </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> dashLine = customGame.<span class="built_in">add</span>.bitmapData(<span class="built_in">width</span> + <span class="number">2</span>*offsetNum , <span class="built_in">height</span> + <span class="number">2</span>*offsetNum);</span><br><span class="line">    <span class="keyword">const</span> wrap = customGame.<span class="built_in">add</span>.<span class="built_in">image</span>(e.x + offsetX - offsetNum, e.y + offsetY - offsetNum, dashLine)</span><br><span class="line">    wrap.name = <span class="string">'wrap'</span>;</span><br><span class="line">    wrap.keyNum = e.keyNum;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//绘制虚线</span></span><br><span class="line">    dashLine.ctx.shadowColor = <span class="string">'#a93e26'</span>;</span><br><span class="line">    dashLine.ctx.shadowBlur = <span class="number">20</span>;</span><br><span class="line">    dashLine.ctx.beginPath();</span><br><span class="line">    dashLine.ctx.lineWidth = <span class="number">6</span>;</span><br><span class="line">    dashLine.ctx.strokeStyle = <span class="string">'white'</span>;</span><br><span class="line">    dashLine.ctx.setLineDash([<span class="number">12</span> , <span class="number">12</span>]);</span><br><span class="line">    dashLine.ctx.moveTo(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    dashLine.ctx.lineTo(boxWidth , <span class="number">0</span>);</span><br><span class="line">    dashLine.ctx.lineTo(boxWidth , boxHeight);</span><br><span class="line">    dashLine.ctx.lineTo(<span class="number">0</span> , boxHeight);</span><br><span class="line">    dashLine.ctx.lineTo(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    dashLine.ctx.<span class="built_in">stroke</span>();</span><br><span class="line">    dashLine.ctx.closePath();</span><br><span class="line">    wrap.bitmapDatas = dashLine;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除按钮</span></span><br><span class="line">    <span class="keyword">const</span> close = customGame.<span class="built_in">add</span>.sprite(- <span class="number">27</span>, <span class="number">-23</span>,<span class="string">'objects'</span>,<span class="string">'close.png'</span>);</span><br><span class="line">    close.inputEnabled = <span class="keyword">true</span>;</span><br><span class="line">    close.events.onInputDown.<span class="built_in">add</span>(<span class="keyword">this</span>.deleteObject , <span class="keyword">this</span> , <span class="keyword">null</span> , e , e._frame.name);</span><br><span class="line">    wrap.addChild(close);</span><br><span class="line">    <span class="comment">//放大按钮</span></span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">scale</span> = customGame.<span class="built_in">add</span>.sprite(boxWidth - <span class="number">27</span> , <span class="number">-23</span> , <span class="string">'objects'</span> , <span class="string">'scale.png'</span>);</span><br><span class="line">    <span class="built_in">scale</span>.inputEnabled = <span class="keyword">true</span>;</span><br><span class="line">    <span class="built_in">scale</span>.events.onInputDown.<span class="built_in">add</span>(function(ev , pt)&#123;</span><br><span class="line">        <span class="comment">//判断用户是否要缩放元素</span></span><br><span class="line">        <span class="keyword">this</span>.isOnTarget = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.onScaleTarget = e;</span><br><span class="line">        <span class="keyword">this</span>.onScaleTargetValue = e.<span class="built_in">scale</span>.x;</span><br><span class="line">    &#125; , <span class="keyword">this</span>);</span><br><span class="line">    </span><br><span class="line">    wrap.addChild(<span class="built_in">scale</span>);</span><br><span class="line">    <span class="keyword">this</span>.selectWrap = wrap;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>绘制虚线框使用了<code>BitmapData</code>api实现，<code>BitmapData</code>对象可以有canvas context的操作，可以作为图片或雪碧图的texture。</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">create : function()&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">this</span>.bindScaleEvent();</span><br><span class="line">&#125;,</span><br><span class="line">bindScaleEvent : function()&#123;</span><br><span class="line">    <span class="keyword">this</span>.isOnTarget = <span class="literal">false</span>;    <span class="comment">//判断是否按了当前选中元素的缩放按钮</span></span><br><span class="line">    <span class="keyword">this</span>.onScaleTarget = <span class="literal">null</span>;      <span class="comment">//选中元素</span></span><br><span class="line">    <span class="keyword">this</span>.objectscaleRate = <span class="literal">null</span>;        <span class="comment">//通过滑动位置计算出得缩放倍数</span></span><br><span class="line">    <span class="keyword">this</span>.onScaleTargetValue = <span class="literal">null</span>;     <span class="comment">//选中元素当前的缩放倍数</span></span><br><span class="line"></span><br><span class="line">    customGame.input.addMoveCallback(function(e)&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">this</span>.isOnTarget) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        const currentMoveX = arguments[<span class="number">1</span>] == <span class="number">0</span> ? <span class="number">1</span> : arguments[<span class="number">1</span>];</span><br><span class="line">        const currentMoveY = arguments[<span class="number">2</span>] == <span class="number">0</span> ? <span class="number">1</span> : arguments[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">this</span>.objectscaleRate)&#123;</span><br><span class="line">            <span class="keyword">this</span>.objectscaleRate = currentMoveX / currentMoveY;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        const currentRate = currentMoveX / currentMoveY;</span><br><span class="line">        <span class="comment">//元素的缩放要以上一次缩放后的倍数被基础进行缩放</span></span><br><span class="line">        let scaleRate = currentRate / <span class="keyword">this</span>.objectscaleRate - <span class="number">1</span> + <span class="keyword">this</span>.onScaleTargetValue;</span><br><span class="line">        scaleRate = scaleRate &lt;= <span class="number">0.25</span> ? <span class="number">0.25</span> : scaleRate &gt;=<span class="number">2</span> ? <span class="number">2</span> : scaleRate;</span><br><span class="line">        <span class="keyword">this</span>.onScaleTarget.scale.<span class="keyword">set</span>(scaleRate);</span><br><span class="line"></span><br><span class="line">        const dashLine = <span class="keyword">this</span>.selectWrap.bitmapDatas;</span><br><span class="line">        const onScaleTarget = <span class="keyword">this</span>.onScaleTarget;</span><br><span class="line">        const scaleBtn = <span class="keyword">this</span>.selectWrap.getChildAt(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        const offsetNum = <span class="number">10</span> , </span><br><span class="line">                width = onScaleTarget.width,</span><br><span class="line">                height = onScaleTarget.height, </span><br><span class="line">                offsetX = -width/<span class="number">2</span> ,</span><br><span class="line">                offsetY = -height / <span class="number">2</span>,</span><br><span class="line">                boxWidth = width + <span class="number">2</span>*offsetNum , </span><br><span class="line">                boxHeight = height + <span class="number">2</span>*offsetNum; </span><br><span class="line">        <span class="comment">//元素需要缩放，编辑框只缩放尺寸，不缩放按钮和虚线实际大小，因此每次缩放都要重新绘制虚线框</span></span><br><span class="line">        dashLine.clear(<span class="number">0</span>,<span class="number">0</span>,<span class="keyword">this</span>.selectWrap.width , <span class="keyword">this</span>.selectWrap.height);</span><br><span class="line">        dashLine.resize(width + <span class="number">2</span>*offsetNum , height + <span class="number">2</span>*offsetNum)</span><br><span class="line">        <span class="keyword">this</span>.selectWrap.x = onScaleTarget.x + offsetX - offsetNum, </span><br><span class="line">        <span class="keyword">this</span>.selectWrap.y = onScaleTarget.y + offsetY - offsetNum;</span><br><span class="line">        scaleBtn.x = <span class="keyword">this</span>.selectWrap.width - <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line">        dashLine.ctx.shadowColor = <span class="string">'#a93e26'</span>;</span><br><span class="line">        dashLine.ctx.shadowBlur = <span class="number">20</span>;</span><br><span class="line">        dashLine.ctx.shadowOffsetX = <span class="number">0</span>;</span><br><span class="line">        dashLine.ctx.shadowOffsetY = <span class="number">0</span>;</span><br><span class="line">        dashLine.ctx.beginPath();</span><br><span class="line">        dashLine.ctx.lineWidth = <span class="number">6</span>;</span><br><span class="line">        dashLine.ctx.strokeStyle = <span class="string">'white'</span>;</span><br><span class="line">        dashLine.ctx.setLineDash([<span class="number">12</span> , <span class="number">12</span>]);</span><br><span class="line">        dashLine.ctx.moveTo(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        dashLine.ctx.lineTo(boxWidth , <span class="number">0</span>);</span><br><span class="line">        dashLine.ctx.lineTo(boxWidth , boxHeight);</span><br><span class="line">        dashLine.ctx.lineTo(<span class="number">0</span> , boxHeight);</span><br><span class="line">        dashLine.ctx.lineTo(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        dashLine.ctx.stroke();</span><br><span class="line">        dashLine.ctx.closePath();</span><br><span class="line">    &#125; , <span class="keyword">this</span>);</span><br><span class="line">    customGame.input.onUp.add(function()&#123;</span><br><span class="line">        <span class="keyword">this</span>.isOnTarget = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">this</span>.onScaleTarget = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.objectscaleRate = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.onScaleTargetValue = <span class="literal">null</span>;</span><br><span class="line">    &#125; , <span class="keyword">this</span>);</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>由于元素的缩放都会改变尺寸，编辑框的只缩放虚线框尺寸，不改变按钮的尺寸大小，因此每次缩放都要清楚编辑框，重新绘制编辑框。</p>
<p><br></p>
<h4 id="4-生成长图"><a href="#4-生成长图" class="headerlink" title="4.生成长图"></a>4.生成长图</h4><p>生成长图较为简单，只需要通过<code>game.canvas.toDataURL</code>生成。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">createFinishBtn : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    finishBtn.events.onInputUp.add(<span class="keyword">this</span>.finishPuzzle , <span class="keyword">this</span>);</span><br><span class="line">&#125;,</span><br><span class="line">finishPuzzle : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//显示结果页</span></span><br><span class="line">    $(<span class="string">'.J_finish'</span>).show();</span><br><span class="line">    <span class="comment">//删除编辑框</span></span><br><span class="line">    <span class="keyword">this</span>.deleteCurrentWrap();</span><br><span class="line">    <span class="comment">//隐藏选择元素面板</span></span><br><span class="line">    <span class="keyword">this</span>.editGroup.visible = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//创建底部结果二维码等</span></span><br><span class="line">    <span class="keyword">this</span>.createResultBottom();</span><br><span class="line">    <span class="comment">//隐藏选择元素面板和创建底部结果二维码需要时间，需要间隔一段时候后再生成长图</span></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.uploadImage();</span><br><span class="line">    &#125; , <span class="number">100</span>);</span><br><span class="line">&#125;,</span><br><span class="line">uploadImage : <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> dataUrl = customGame.canvas.toDataURL(<span class="string">'image/jpeg'</span> , <span class="number">0.7</span>);</span><br><span class="line">    <span class="comment">//todo 可以在此将图片上传到服务器再更新到结果页</span></span><br><span class="line">    <span class="keyword">this</span>.showResult(dataUrl);</span><br><span class="line">&#125;,</span><br><span class="line">showResult : <span class="function"><span class="keyword">function</span>(<span class="params">src</span>)</span>&#123;</span><br><span class="line">    $(<span class="string">'.J_finish .result'</span>).attr(<span class="string">'src'</span> , src).css(&#123; <span class="attr">opacity</span> : <span class="number">1</span>&#125;);</span><br><span class="line">    $(<span class="string">'.J_finish .btm'</span>).css(&#123;<span class="attr">opacity</span> : <span class="number">1</span>&#125;);</span><br><span class="line">    $(<span class="string">'.J_finish .load'</span>).hide();</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p><br></p>
<h1 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h1><p>以上是这个h5的主要实现过程，由于代码细节较多，部分代码未贴出，需要配合源码阅读～～</p>
<p><a href="https://github.com/ZENGzoe/phaser-puzzle.git" target="_blank" rel="noopener">源码：https://github.com/ZENGzoe/phaser-puzzle.git</a><br><a href="https://zengzoe.github.io/phaser-puzzle/dist/">demo：https://zengzoe.github.io/phaser-puzzle/dist/</a><br><img src="/2019/01/24/如何用Phaser实现一个全家福拼图h5/07.png" alt=""></p>
<p><br></p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a href="https://phaser.io/" target="_blank" rel="noopener">1.https://phaser.io/</a><br></p>
</div></article></div></section><footer><div class="paginator"><a href="/2019/04/12/数据库递归查询：MySQL-VS-Sequelize/" class="prev">PRVE</a><a href="/2019/01/24/ES2018新特性学习/" class="next">NEXT</a></div><div data-thread-key="2019/01/24/如何用Phaser实现一个全家福拼图h5/" data-title="如何用Phaser实现一个全家福拼图H5" data-url="http://zengzoe.github.io/2019/01/24/如何用Phaser实现一个全家福拼图h5/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"zengzoe"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2016 - 2019 <a href="http://zengzoe.github.io">Zeng Zoe</a>, unless otherwise noted.</p><p style="display:none !important;"><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span><span id="busuanzi_container_site_uv">本站总访客数<span id="busuanzi_value_site_uv"></span>人次</span></p></div></footer><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>